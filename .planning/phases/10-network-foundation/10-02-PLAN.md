---
phase: 10-network-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SharpDicom/Network/Items/PresentationContext.cs
  - src/SharpDicom/Network/Items/PresentationContextResult.cs
  - src/SharpDicom/Network/Items/UserInformation.cs
  - src/SharpDicom/Network/Items/PresentationDataValue.cs
  - src/SharpDicom/Network/AssociationOptions.cs
  - tests/SharpDicom.Tests/Network/Items/PresentationContextTests.cs
autonomous: true

must_haves:
  truths:
    - "Presentation context IDs are validated as odd integers 1-255"
    - "User information includes max PDU length and implementation identifiers"
    - "Association options provide configurable timeouts and AE titles"
  artifacts:
    - path: "src/SharpDicom/Network/Items/PresentationContext.cs"
      provides: "Presentation context for association negotiation"
      contains: "public sealed class PresentationContext"
    - path: "src/SharpDicom/Network/Items/UserInformation.cs"
      provides: "User information sub-items"
      contains: "public sealed class UserInformation"
    - path: "src/SharpDicom/Network/AssociationOptions.cs"
      provides: "Association configuration"
      contains: "public sealed class AssociationOptions"
  key_links:
    - from: "PresentationContext"
      to: "TransferSyntax"
      via: "accepted transfer syntax list"
      pattern: "IReadOnlyList<TransferSyntax>"
    - from: "AssociationOptions"
      to: "PresentationContext"
      via: "proposed contexts"
      pattern: "IReadOnlyList<PresentationContext>"
---

<objective>
Create PDU sub-items and association configuration types for DICOM networking.

Purpose: Define the data structures for presentation context negotiation, user information exchange, and association configuration. These types are used during A-ASSOCIATE-RQ/AC exchange to establish the communication parameters.

Output: Presentation context, user information, and association options classes that support association negotiation.
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-network-foundation/10-RESEARCH.md
@.planning/phases/10-network-foundation/10-CONTEXT.md

Reference existing patterns:
@src/SharpDicom/Data/TransferSyntax.cs
@src/SharpDicom/Data/DicomUID.cs
@src/SharpDicom/IO/DicomReaderOptions.cs (for options pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Presentation context types</name>
  <files>
    src/SharpDicom/Network/Items/PresentationContext.cs
    src/SharpDicom/Network/Items/PresentationContextResult.cs
  </files>
  <action>
Create Network/Items directory with:

1. **PresentationContextResult.cs** - Enum for A-ASSOCIATE-AC result values:
   - Acceptance = 0
   - UserRejection = 1
   - NoReason = 2
   - AbstractSyntaxNotSupported = 3
   - TransferSyntaxesNotSupported = 4

2. **PresentationContext.cs** - Sealed class for negotiation:
   - `byte Id` - Must be odd (1-255), validated in constructor
   - `DicomUID AbstractSyntax` - SOP Class UID
   - `IReadOnlyList<TransferSyntax> TransferSyntaxes` - Proposed/accepted list
   - `PresentationContextResult? Result` - Set after negotiation (null for request)
   - `TransferSyntax? AcceptedTransferSyntax` - The single accepted syntax (null if rejected)

   Constructor: `PresentationContext(byte id, DicomUID abstractSyntax, params TransferSyntax[] transferSyntaxes)`
   - Validate id is odd and in range 1-255, throw ArgumentOutOfRangeException if not
   - Validate abstractSyntax is not null
   - Validate at least one transfer syntax provided

   Static factory: `CreateAccepted(byte id, DicomUID abstractSyntax, TransferSyntax accepted)`
   - Returns PresentationContext with Result=Acceptance and AcceptedTransferSyntax set

   Static factory: `CreateRejected(byte id, DicomUID abstractSyntax, PresentationContextResult reason)`
   - Returns PresentationContext with Result set to rejection reason

   Helper: `static bool IsValidId(byte id) => id >= 1 && id <= 255 && (id & 1) == 1`
  </action>
  <verify>
dotnet build src/SharpDicom/SharpDicom.csproj
  </verify>
  <done>
PresentationContext validates ID as odd 1-255. Result and AcceptedTransferSyntax track negotiation outcome.
  </done>
</task>

<task type="auto">
  <name>Task 2: User information and presentation data value</name>
  <files>
    src/SharpDicom/Network/Items/UserInformation.cs
    src/SharpDicom/Network/Items/PresentationDataValue.cs
  </files>
  <action>
1. **UserInformation.cs** - Sealed class for User Information sub-items:
   - `uint MaxPduLength` - Maximum PDU size (default 16384)
   - `string ImplementationClassUid` - Our implementation UID (required)
   - `string? ImplementationVersionName` - Optional version string (max 16 chars)

   Constructor validates:
   - MaxPduLength >= PduConstants.MinMaxPduLength (4096) - some implementations require minimum
   - ImplementationClassUid is valid UID format
   - ImplementationVersionName length <= 16 if provided

   Static property: `Default` - Returns UserInformation with:
   - MaxPduLength = 16384
   - ImplementationClassUid = "2.25.{guid}" (generate once and cache)
   - ImplementationVersionName = "SharpDicom" (or version if fits)

2. **PresentationDataValue.cs** - Struct for P-DATA-TF content:
   - `byte PresentationContextId` - Which presentation context
   - `bool IsCommand` - True if command, false if data (from message control header)
   - `bool IsLastFragment` - True if this is the last fragment
   - `ReadOnlyMemory<byte> Data` - Fragment payload

   This is what gets extracted from P-DATA-TF PDUs. Each PDU can contain multiple PDVs.

Add PduConstants.MinMaxPduLength = 4096 to PduConstants.cs.
  </action>
  <verify>
dotnet build src/SharpDicom/SharpDicom.csproj
  </verify>
  <done>
UserInformation encapsulates all User Information sub-items. PresentationDataValue represents P-DATA content.
  </done>
</task>

<task type="auto">
  <name>Task 3: Association options and tests</name>
  <files>
    src/SharpDicom/Network/AssociationOptions.cs
    tests/SharpDicom.Tests/Network/Items/PresentationContextTests.cs
  </files>
  <action>
1. **AssociationOptions.cs** - Sealed class for association configuration:
   - `string CalledAETitle` - Remote AE title (max 16 chars, validated)
   - `string CallingAETitle` - Local AE title (max 16 chars, validated)
   - `IReadOnlyList<PresentationContext> PresentationContexts` - Proposed contexts
   - `UserInformation UserInformation` - Our user info (default: UserInformation.Default)
   - `TimeSpan ArtimTimeout` - ARTIM timer timeout (default: 30 seconds per DICOM spec)
   - `TimeSpan DimseTimeout` - DIMSE response timeout (default: 60 seconds)

   Constructor validates:
   - AE titles are 1-16 ASCII characters, no leading/trailing spaces in content
   - At least one presentation context
   - All presentation context IDs are unique

   Builder pattern for fluent configuration:
   ```csharp
   public sealed class AssociationOptionsBuilder
   {
       public AssociationOptionsBuilder WithCalledAE(string ae);
       public AssociationOptionsBuilder WithCallingAE(string ae);
       public AssociationOptionsBuilder AddPresentationContext(PresentationContext ctx);
       public AssociationOptionsBuilder WithUserInformation(UserInformation info);
       public AssociationOptionsBuilder WithArtimTimeout(TimeSpan timeout);
       public AssociationOptionsBuilder WithDimseTimeout(TimeSpan timeout);
       public AssociationOptions Build();
   }
   ```

2. **PresentationContextTests.cs** - Unit tests:
   - Valid ID (1, 3, 255) accepted
   - Invalid ID (0, 2, 256) throws ArgumentOutOfRangeException
   - CreateAccepted sets Result and AcceptedTransferSyntax
   - CreateRejected sets Result, AcceptedTransferSyntax is null
   - Empty transfer syntax list throws
   - Null abstract syntax throws
  </action>
  <verify>
dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj --filter "FullyQualifiedName~PresentationContextTests"
  </verify>
  <done>
AssociationOptions validates AE titles and presentation context uniqueness. All PresentationContext tests pass.
  </done>
</task>

</tasks>

<verification>
All verification commands must pass:

```bash
# Build the library
dotnet build src/SharpDicom/SharpDicom.csproj --configuration Release

# Run all tests
dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj

# Verify new types exist
grep -r "public sealed class PresentationContext" src/SharpDicom/Network/
grep -r "public sealed class UserInformation" src/SharpDicom/Network/
grep -r "public sealed class AssociationOptions" src/SharpDicom/Network/
```
</verification>

<success_criteria>
- PresentationContext validates ID is odd integer 1-255
- UserInformation provides default implementation UID
- AssociationOptions validates AE titles and context uniqueness
- PresentationDataValue captures P-DATA content correctly
- All tests pass (existing + new PresentationContext tests)
- No build warnings
</success_criteria>

<output>
After completion, create `.planning/phases/10-network-foundation/10-02-SUMMARY.md`
</output>
