---
phase: 14-de-identification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - data/dicom-standard/part15.xml
  - src/SharpDicom.Generators/Parsing/Part15Parser.cs
  - src/SharpDicom.Generators/Parsing/DeidentificationActionDefinition.cs
  - src/SharpDicom.Generators/Emitters/DeidentificationEmitter.cs
  - src/SharpDicom.Generators/DicomDictionaryGenerator.cs
  - src/SharpDicom/Deidentification/DeidentificationProfiles.cs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Source generator parses part15.xml table E.1-1"
    - "Generated code provides action lookup by DicomTag"
    - "All profile options have action columns parsed"
    - "Action codes (D, Z, X, K, C, U, compound) are represented"
  artifacts:
    - path: "data/dicom-standard/part15.xml"
      provides: "PS3.15 Security profiles XML source"
    - path: "src/SharpDicom.Generators/Parsing/Part15Parser.cs"
      provides: "XML parsing for table E.1-1"
      exports: ["ParseDeidentificationActions"]
    - path: "src/SharpDicom.Generators/Emitters/DeidentificationEmitter.cs"
      provides: "Code generation for action tables"
      exports: ["Emit"]
    - path: "src/SharpDicom/Deidentification/DeidentificationProfiles.Generated.cs"
      provides: "Generated action lookup tables"
  key_links:
    - from: "DicomDictionaryGenerator.cs"
      to: "Part15Parser.cs"
      via: "AdditionalTextsProvider filter for part15.xml"
      pattern: "part15\\.xml"
    - from: "Part15Parser.cs"
      to: "DeidentificationEmitter.cs"
      via: "parsed definitions passed to emitter"
      pattern: "DeidentificationActionDefinition"
---

<objective>
Create source generator that parses NEMA part15.xml to generate de-identification action tables at compile time.

Purpose: Foundation for standards-compliant PS3.15 de-identification with all profile options
Output: DeidentificationProfiles.Generated.cs with action lookup by tag and profile option
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-de-identification/14-RESEARCH.md
@src/SharpDicom.Generators/DicomDictionaryGenerator.cs
@src/SharpDicom.Generators/Parsing/Part6Parser.cs
@src/SharpDicom.Generators/Emitters/DictionaryEmitter.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Download part15.xml and create parser types</name>
  <files>
    data/dicom-standard/part15.xml
    src/SharpDicom.Generators/Parsing/DeidentificationActionDefinition.cs
    src/SharpDicom.Generators/Parsing/Part15Parser.cs
  </files>
  <action>
Download NEMA part15.xml from https://dicom.nema.org/medical/dicom/current/source/docbook/part15/part15.xml to data/dicom-standard/part15.xml (curl or wget).

Create DeidentificationActionDefinition record:
```csharp
public record DeidentificationActionDefinition(
    ushort Group,
    ushort Element,
    string AttributeName,
    bool IsRetired,
    bool InStandardIOD,
    string BasicProfileAction,
    string? RetainSafePrivateAction,
    string? RetainUidsAction,
    string? RetainDeviceIdentityAction,
    string? RetainInstitutionIdentityAction,
    string? RetainPatientCharsAction,
    string? RetainLongFullDatesAction,
    string? RetainLongModifiedDatesAction,
    string? CleanDescriptorsAction,
    string? CleanStructuredContentAction,
    string? CleanGraphicsAction
);
```

Create Part15Parser static class following Part6Parser pattern:
- Use DocBook namespace: http://docbook.org/ns/docbook
- Find table with xml:id="table_E.1-1" (Application Level Confidentiality Profile Attributes)
- Parse tbody/tr rows: 15 columns (name, tag, retired, in-iod, basic-profile, 10 option columns)
- Extract tag from "(GGGG,EEEE)" format using regex
- Handle empty cells (no para element or empty para) as null action
- Return IEnumerable of DeidentificationActionDefinition
  </action>
  <verify>
Build succeeds: `dotnet build src/SharpDicom.Generators`
Part15Parser compiles without errors
  </verify>
  <done>
part15.xml exists in data/dicom-standard/
DeidentificationActionDefinition record defined
Part15Parser.ParseDeidentificationActions method implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Create emitter and integrate into generator</name>
  <files>
    src/SharpDicom.Generators/Emitters/DeidentificationEmitter.cs
    src/SharpDicom.Generators/DicomDictionaryGenerator.cs
    src/SharpDicom/Deidentification/DeidentificationProfiles.cs
  </files>
  <action>
Create DeidentificationEmitter following DictionaryEmitter pattern:
- Generate DeidentificationProfiles.Generated.cs in SharpDicom/Deidentification/
- Generate DeidentificationAction enum: D, Z, X, K, C, U, ZD, XZ, XD, XZD, XZU
- Generate DeidentificationOption flags enum for profile options
- Generate static FrozenDictionary (or Dictionary for netstandard2.0) mapping DicomTag to action per profile
- Generate GetAction(DicomTag tag, DeidentificationOptions options) method that resolves combined options

Add part15.xml pipeline to DicomDictionaryGenerator.Initialize():
- Filter AdditionalTextsProvider for part15.xml
- Parse with Part15Parser.ParseDeidentificationActions
- Emit with DeidentificationEmitter.Emit
- Register source output as "DeidentificationProfiles.Generated.cs"

Create DeidentificationProfiles.cs partial class stub (non-generated part):
```csharp
namespace SharpDicom.Deidentification;

public static partial class DeidentificationProfiles
{
    // Generated members in DeidentificationProfiles.Generated.cs
}
```

Update SharpDicom.csproj to include part15.xml as AdditionalFiles (same pattern as part06.xml).
  </action>
  <verify>
Build solution: `dotnet build`
Generated file appears in obj/ folder
DeidentificationProfiles has BasicProfile dictionary with ~600 entries
  </verify>
  <done>
DeidentificationEmitter generates valid C# code
DicomDictionaryGenerator includes part15.xml pipeline
DeidentificationProfiles.Generated.cs compiles with action lookup methods
Generated code includes all 11 action codes and 10 profile options
  </done>
</task>

<task type="auto">
  <name>Task 3: Add generator tests</name>
  <files>
    tests/SharpDicom.Tests/Generators/Part15ParserTests.cs
    tests/SharpDicom.Tests/Deidentification/DeidentificationProfilesTests.cs
  </files>
  <action>
Create Part15ParserTests:
- Test parsing sample XML snippet with known attributes
- Verify Accession Number (0008,0050) has Basic Profile action "Z"
- Verify Patient Name (0010,0010) has Basic Profile action "Z"
- Verify SOP Instance UID (0008,0018) has Basic Profile action "U"
- Verify retired attribute detection
- Verify option column parsing (empty = null)

Create DeidentificationProfilesTests:
- Test BasicProfile dictionary has expected count (~600 entries)
- Test GetAction for known tags returns correct action
- Test GetAction with RetainUIDs option returns K for UID tags
- Test GetAction with CleanDescriptors option returns appropriate action
- Test compound action representation (Z/D, X/Z, etc.)
  </action>
  <verify>
All tests pass: `dotnet test tests/SharpDicom.Tests --filter "Part15|Deidentification"`
  </verify>
  <done>
Part15Parser correctly parses table E.1-1 structure
Generated action lookup works for all profile combinations
At least 500 tag actions generated (expect ~600)
  </done>
</task>

</tasks>

<verification>
```bash
# Build generator
dotnet build src/SharpDicom.Generators

# Build main project (triggers generator)
dotnet build src/SharpDicom

# Verify generated file exists
ls src/SharpDicom/obj/*/net*/SharpDicom.Generators/DeidentificationProfiles.Generated.cs

# Run generator tests
dotnet test tests/SharpDicom.Tests --filter "Part15|DeidentificationProfiles"
```
</verification>

<success_criteria>
- part15.xml cached in data/dicom-standard/
- Source generator parses ~600 attribute action definitions
- DeidentificationAction enum has all 11 action codes
- DeidentificationOption flags enum has all 10 profile options
- GetAction method resolves combined profile options correctly
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-de-identification/14-01-SUMMARY.md`
</output>
