---
phase: 08-validation
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/SharpDicom/Validation/Rules/DateValidator.cs
  - src/SharpDicom/Validation/Rules/TimeValidator.cs
  - src/SharpDicom/Validation/Rules/DateTimeValidator.cs
  - src/SharpDicom/Validation/Rules/AgeStringValidator.cs
  - src/SharpDicom/Validation/Rules/UidValidator.cs
  - src/SharpDicom/Validation/Rules/PersonNameValidator.cs
  - src/SharpDicom/Validation/Rules/CodeStringValidator.cs
  - src/SharpDicom/Validation/Rules/StringLengthValidator.cs
  - src/SharpDicom/Validation/Rules/CharacterRepertoireValidator.cs
  - src/SharpDicom/Validation/StandardRules.cs
  - tests/SharpDicom.Tests/Validation/Rules/DateValidatorTests.cs
  - tests/SharpDicom.Tests/Validation/Rules/UidValidatorTests.cs
  - tests/SharpDicom.Tests/Validation/Rules/CharacterValidatorTests.cs
autonomous: true

must_haves:
  truths:
    - "DA values validate YYYYMMDD format with real date checking"
    - "TM values validate HHMMSS.FFFFFF format"
    - "UI values validate UID format (digits, dots, no leading zeros, max 64 chars)"
    - "Character repertoire rules enforce VR-specific allowed characters"
    - "StandardRules.All provides collection of all built-in validators"
  artifacts:
    - path: "src/SharpDicom/Validation/Rules/DateValidator.cs"
      provides: "DA format validation"
      exports: ["DateValidator"]
    - path: "src/SharpDicom/Validation/Rules/UidValidator.cs"
      provides: "UI format validation"
      exports: ["UidValidator"]
    - path: "src/SharpDicom/Validation/StandardRules.cs"
      provides: "Collection of all standard validators"
      exports: ["StandardRules"]
    - path: "tests/SharpDicom.Tests/Validation/Rules/DateValidatorTests.cs"
      provides: "Date validation edge case coverage"
      min_lines: 80
  key_links:
    - from: "DateValidator"
      to: "IValidationRule"
      via: "interface implementation"
      pattern: "class DateValidator : IValidationRule"
    - from: "StandardRules.All"
      to: "IValidationRule[]"
      via: "static collection"
      pattern: "IReadOnlyList<IValidationRule> All"
---

<objective>
Implement built-in VR validators for date, time, UID, person name, code string, and character repertoire constraints.

Purpose: These validators enforce DICOM PS3.5 Section 6.2 format requirements. They detect common real-world conformance issues like invalid dates, malformed UIDs, and incorrect character sets.

Output: Rules subfolder with 9 validator classes and StandardRules collection, plus comprehensive tests.
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-validation/08-CONTEXT.md
@.planning/phases/08-validation/08-RESEARCH.md

# Core validation types from Plan 01
@src/SharpDicom/Validation/ValidationIssue.cs
@src/SharpDicom/Validation/ValidationCodes.cs
@src/SharpDicom/Validation/IValidationRule.cs
@src/SharpDicom/Validation/ElementValidationContext.cs

# Existing VR definitions
@src/SharpDicom/Data/DicomVR.cs
@src/SharpDicom/Data/DicomVRInfo.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create date/time validators</name>
  <files>
    src/SharpDicom/Validation/Rules/DateValidator.cs
    src/SharpDicom/Validation/Rules/TimeValidator.cs
    src/SharpDicom/Validation/Rules/DateTimeValidator.cs
    src/SharpDicom/Validation/Rules/AgeStringValidator.cs
  </files>
  <action>
Create Rules subfolder under Validation/. Implement validators following RESEARCH.md patterns.

**DateValidator.cs (DA - YYYYMMDD):**
- Implements IValidationRule
- RuleId: "VR-DA-FORMAT"
- Description: "Validates DA (Date) format: YYYYMMDD"
- Validate method:
  - Return null if VR is not DA
  - Trim trailing space padding (0x20)
  - Empty value is valid (Type 2 support)
  - Validate length is 8, 6, or 4 characters
  - Validate all characters are digits 0-9
  - Parse and validate year (1-9999)
  - Parse and validate month (1-12)
  - Parse and validate day (1 to DateTime.DaysInMonth)
  - Use ValidationCodes.InvalidDateFormat or InvalidDateValue
  - Include actual value in message for diagnostics

**TimeValidator.cs (TM - HHMMSS.FFFFFF):**
- RuleId: "VR-TM-FORMAT"
- Handles partial times (HH, HHMM, HHMMSS, with optional .FFFFFF)
- Validate hours 0-23, minutes 0-59, seconds 0-59
- Fractional seconds must be digits only
- Maximum 14 characters (16 with padding)

**DateTimeValidator.cs (DT - YYYYMMDDHHMMSS.FFFFFF+ZZZZ):**
- RuleId: "VR-DT-FORMAT"
- Combines DA + TM validation
- Optional timezone offset (+/- HHMM or ZZXX)
- Maximum 26 characters

**AgeStringValidator.cs (AS - nnnW/M/Y/D):**
- RuleId: "VR-AS-FORMAT"
- Fixed 4 characters
- First 3 must be digits
- Fourth must be D, W, M, or Y (case-sensitive)

All validators should:
- Use `in ElementValidationContext` for zero-copy
- Work on RawValue.Span directly
- Return ValidationIssue? (null if valid)
- Include helpful SuggestedFix values
  </action>
  <verify>
    - `dotnet build src/SharpDicom/SharpDicom.csproj` succeeds
    - All four validator classes compile and implement IValidationRule
  </verify>
  <done>
    - DateValidator handles YYYYMMDD with real date validation
    - TimeValidator handles HHMMSS.FFFFFF with bounds checking
    - DateTimeValidator combines date+time+timezone
    - AgeStringValidator enforces nnnX format
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UID, PN, CS, and character validators</name>
  <files>
    src/SharpDicom/Validation/Rules/UidValidator.cs
    src/SharpDicom/Validation/Rules/PersonNameValidator.cs
    src/SharpDicom/Validation/Rules/CodeStringValidator.cs
    src/SharpDicom/Validation/Rules/StringLengthValidator.cs
    src/SharpDicom/Validation/Rules/CharacterRepertoireValidator.cs
    src/SharpDicom/Validation/StandardRules.cs
  </files>
  <action>
**UidValidator.cs (UI):**
- RuleId: "VR-UI-FORMAT"
- Trim trailing null padding (0x00)
- Empty valid for Type 2
- Max 64 characters
- Only digits 0-9 and dots
- No empty components (consecutive dots)
- No leading zeros in components (except "0" itself)
- No leading/trailing dots
- Use ValidationCodes.InvalidUidFormat, ValueTooLong, InvalidCharacter

**PersonNameValidator.cs (PN):**
- RuleId: "VR-PN-FORMAT"
- Up to 3 component groups separated by '='
- Up to 5 components per group separated by '^'
- Each component max 64 characters
- Total max 64 characters per component group (PS3.5)
- Warn on invalid structure but don't reject (many real files have issues)

**CodeStringValidator.cs (CS):**
- RuleId: "VR-CS-FORMAT"
- Allowed: A-Z, 0-9, space, underscore only
- No lowercase letters (common real-world issue)
- Max 16 characters per value
- Leading/trailing spaces trimmed for validation

**StringLengthValidator.cs:**
- RuleId: "VR-LENGTH"
- Generic validator for all string VRs
- Uses DicomVRInfo.MaxLength to check per-VR limits
- AE: 16, AS: 4, CS: 16, DA: 8, DS: 16, DT: 26, IS: 12, LO: 64, etc.

**CharacterRepertoireValidator.cs:**
- RuleId: "VR-CHARS"
- Per-VR character validation based on RESEARCH.md table:
  - AE: default repertoire, no backslash or control chars
  - CS: A-Z, 0-9, space, underscore
  - DA: 0-9 only
  - DS: 0-9, +, -, E, e, ., space
  - IS: 0-9, +, -, space
  - TM: 0-9, ., space
  - UI: 0-9, .
- Pass through if VR is not a constrained string type

**StandardRules.cs:**
```csharp
public static class StandardRules
{
    public static IReadOnlyList<IValidationRule> All { get; } = new IValidationRule[]
    {
        new DateValidator(),
        new TimeValidator(),
        new DateTimeValidator(),
        new AgeStringValidator(),
        new UidValidator(),
        new PersonNameValidator(),
        new CodeStringValidator(),
        new StringLengthValidator(),
        new CharacterRepertoireValidator()
    };

    /// <summary>Structural rules only (fast, minimal checking).</summary>
    public static IReadOnlyList<IValidationRule> StructuralOnly { get; } = new IValidationRule[]
    {
        new StringLengthValidator()
    };
}
```
  </action>
  <verify>
    - `dotnet build` succeeds
    - StandardRules.All contains 9 validators
    - All validators implement IValidationRule
  </verify>
  <done>
    - UidValidator enforces UID format constraints
    - PersonNameValidator checks PN structure
    - CodeStringValidator enforces uppercase and allowed chars
    - StringLengthValidator checks per-VR length limits
    - CharacterRepertoireValidator checks per-VR character constraints
    - StandardRules.All provides all validators
    - StandardRules.StructuralOnly provides minimal set
  </done>
</task>

<task type="auto">
  <name>Task 3: Create validator tests</name>
  <files>
    tests/SharpDicom.Tests/Validation/Rules/DateValidatorTests.cs
    tests/SharpDicom.Tests/Validation/Rules/UidValidatorTests.cs
    tests/SharpDicom.Tests/Validation/Rules/CharacterValidatorTests.cs
  </files>
  <action>
Create Rules subfolder under tests/SharpDicom.Tests/Validation/.

**DateValidatorTests.cs:**
Test cases:
- Valid dates: "20240115", "20240229" (leap year), "19000101"
- Invalid month: "20241301" -> error
- Invalid day: "20240230" -> error (Feb 30)
- Invalid day for month: "20240431" -> error (April has 30 days)
- Invalid format: "2024-01-15" -> error (dashes not allowed)
- Non-digit characters -> error
- Partial dates: "2024", "202401" (valid per DICOM)
- Empty value -> null (valid)
- Wrong VR (CS) -> null (skipped)
- Trailing space padding -> valid

**UidValidatorTests.cs:**
Test cases:
- Valid UID: "1.2.840.10008.1.2"
- Valid with leading "2.25.xxx" (UUID-based)
- Empty -> null (valid)
- Too long (>64 chars) -> error
- Leading zero in component "1.02.3" -> error
- Empty component "1..3" -> error
- Invalid char "1.2.A.3" -> error
- Trailing null padding -> trimmed and valid
- Wrong VR -> null (skipped)

**CharacterValidatorTests.cs:**
Test cases:
- CS with lowercase -> warning
- CS with valid uppercase -> null
- CS with invalid char (@) -> warning
- DA with non-digit -> error
- UI with letter -> error
- DS with valid scientific notation -> null
- IS with leading + -> null
- AE with backslash -> warning
  </action>
  <verify>
    - `dotnet test --filter "FullyQualifiedName~Validation.Rules"` passes
  </verify>
  <done>
    - DateValidatorTests covers all date edge cases
    - UidValidatorTests covers all UID format rules
    - CharacterValidatorTests covers per-VR character constraints
    - All tests pass
  </done>
</task>

</tasks>

<verification>
- `dotnet build` succeeds with no warnings
- `dotnet test` passes all existing tests plus new validator tests
- DateValidator correctly rejects "20240230" (Feb 30 doesn't exist)
- UidValidator correctly rejects "1.02.3" (leading zero)
- CodeStringValidator warns on lowercase "abc" but doesn't throw
- StandardRules.All contains exactly 9 validators
</verification>

<success_criteria>
- Rules subfolder exists with 9 validator classes
- Each validator implements IValidationRule with unique RuleId
- DateValidator validates real dates (leap years, month lengths)
- TimeValidator handles partial times and bounds
- UidValidator enforces all UID constraints from PS3.5
- CharacterRepertoireValidator covers DA, TM, DS, IS, UI, CS, AE
- StandardRules.All and StandardRules.StructuralOnly are populated
- At least 30 unit tests covering validator edge cases
- All tests pass on all target frameworks
</success_criteria>

<output>
After completion, create `.planning/phases/08-validation/08-02-SUMMARY.md`
</output>
