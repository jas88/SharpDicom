---
phase: 08-validation
plan: 03
type: execute
wave: 3
depends_on: ["08-01", "08-02"]
files_modified:
  - src/SharpDicom/Validation/ValidationProfile.cs
  - src/SharpDicom/Validation/ValidationBehavior.cs
  - src/SharpDicom/IO/DicomReaderOptions.cs
  - src/SharpDicom/IO/DicomFileReader.cs
  - src/SharpDicom/DicomFile.cs
  - tests/SharpDicom.Tests/Validation/ValidationProfileTests.cs
  - tests/SharpDicom.Tests/Validation/ValidationIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "ValidationProfile.Strict rejects files with any Error-level issue"
    - "ValidationProfile.Lenient collects issues but continues parsing"
    - "ValidationProfile.Permissive skips most validation for performance"
    - "DicomReaderOptions.ValidationCallback is invoked for each issue"
    - "DicomFile exposes ValidationResult after parsing"
  artifacts:
    - path: "src/SharpDicom/Validation/ValidationProfile.cs"
      provides: "Preset validation configurations"
      exports: ["ValidationProfile"]
    - path: "src/SharpDicom/IO/DicomReaderOptions.cs"
      provides: "Validation integration into reader options"
      contains: "ValidationProfile"
    - path: "tests/SharpDicom.Tests/Validation/ValidationIntegrationTests.cs"
      provides: "End-to-end validation testing"
      min_lines: 100
  key_links:
    - from: "DicomReaderOptions"
      to: "ValidationProfile"
      via: "ValidationProfile property"
      pattern: "ValidationProfile\\? ValidationProfile"
    - from: "DicomFile"
      to: "ValidationResult"
      via: "ValidationResult property"
      pattern: "ValidationResult\\? ValidationResult"
    - from: "DicomFileReader"
      to: "IValidationRule"
      via: "rule invocation during parsing"
      pattern: "rule\\.Validate"
---

<objective>
Create ValidationProfile presets and integrate validation into DicomReaderOptions and the file reading pipeline.

Purpose: Connect the validation infrastructure to actual file parsing, enabling strict/lenient/permissive modes and callback-based validation reporting.

Output: Complete validation system integrated with file reading, with presets for common use cases.
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-validation/08-CONTEXT.md
@.planning/phases/08-validation/08-RESEARCH.md

# Core validation types from Plan 01
@src/SharpDicom/Validation/ValidationIssue.cs
@src/SharpDicom/Validation/ValidationResult.cs
@src/SharpDicom/Validation/IValidationRule.cs

# Validators from Plan 02
@src/SharpDicom/Validation/StandardRules.cs

# Existing I/O infrastructure
@src/SharpDicom/IO/DicomReaderOptions.cs
@src/SharpDicom/IO/DicomFileReader.cs
@src/SharpDicom/DicomFile.cs
@src/SharpDicom/Data/DicomDataset.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ValidationProfile and ValidationBehavior</name>
  <files>
    src/SharpDicom/Validation/ValidationBehavior.cs
    src/SharpDicom/Validation/ValidationProfile.cs
  </files>
  <action>
**ValidationBehavior.cs:**
```csharp
namespace SharpDicom.Validation;

/// <summary>
/// Defines how validation issues are handled.
/// </summary>
public enum ValidationBehavior
{
    /// <summary>Run validation rules, report all issues.</summary>
    Validate,

    /// <summary>Run validation, log warnings but don't abort on errors.</summary>
    Warn,

    /// <summary>Skip validation entirely.</summary>
    Skip
}
```

**ValidationProfile.cs:**
```csharp
namespace SharpDicom.Validation;

using System;
using System.Collections.Generic;
using SharpDicom.Data;

/// <summary>
/// Configuration for validation behavior during parsing.
/// </summary>
public sealed class ValidationProfile
{
    /// <summary>Profile name for logging/debugging.</summary>
    public string Name { get; init; } = "Custom";

    /// <summary>Rules to apply during validation.</summary>
    public IReadOnlyList<IValidationRule> Rules { get; init; } = Array.Empty<IValidationRule>();

    /// <summary>Default behavior for tags not in TagOverrides.</summary>
    public ValidationBehavior DefaultBehavior { get; init; } = ValidationBehavior.Validate;

    /// <summary>Per-tag behavior overrides.</summary>
    public IReadOnlyDictionary<DicomTag, ValidationBehavior>? TagOverrides { get; init; }

    /// <summary>Strict: all rules, abort on any Error.</summary>
    public static ValidationProfile Strict { get; } = new()
    {
        Name = "Strict",
        Rules = StandardRules.All,
        DefaultBehavior = ValidationBehavior.Validate
    };

    /// <summary>Lenient: all rules, collect issues but continue.</summary>
    public static ValidationProfile Lenient { get; } = new()
    {
        Name = "Lenient",
        Rules = StandardRules.All,
        DefaultBehavior = ValidationBehavior.Warn
    };

    /// <summary>Permissive: structural rules only, continue on errors.</summary>
    public static ValidationProfile Permissive { get; } = new()
    {
        Name = "Permissive",
        Rules = StandardRules.StructuralOnly,
        DefaultBehavior = ValidationBehavior.Skip
    };

    /// <summary>None: skip all validation for maximum performance.</summary>
    public static ValidationProfile None { get; } = new()
    {
        Name = "None",
        Rules = Array.Empty<IValidationRule>(),
        DefaultBehavior = ValidationBehavior.Skip
    };

    /// <summary>
    /// Gets the behavior for a specific tag.
    /// </summary>
    public ValidationBehavior GetBehavior(DicomTag tag)
    {
        if (TagOverrides != null && TagOverrides.TryGetValue(tag, out var behavior))
            return behavior;
        return DefaultBehavior;
    }
}
```
  </action>
  <verify>
    - `dotnet build src/SharpDicom/SharpDicom.csproj` succeeds
    - ValidationProfile.Strict, Lenient, Permissive, None are all accessible
  </verify>
  <done>
    - ValidationBehavior enum with Validate/Warn/Skip
    - ValidationProfile with Name, Rules, DefaultBehavior, TagOverrides
    - Four static presets: Strict, Lenient, Permissive, None
    - GetBehavior method for per-tag override lookup
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate validation into DicomReaderOptions and DicomFile</name>
  <files>
    src/SharpDicom/IO/DicomReaderOptions.cs
    src/SharpDicom/DicomFile.cs
  </files>
  <action>
**Update DicomReaderOptions.cs:**
Add these properties:

```csharp
using SharpDicom.Validation;

// Add to DicomReaderOptions class:

/// <summary>
/// Gets or sets the validation profile to use during parsing.
/// </summary>
/// <remarks>
/// When set, validation rules run during element parsing.
/// Issues are collected in DicomFile.ValidationResult and/or passed to ValidationCallback.
/// Default is null (no validation).
/// </remarks>
public ValidationProfile? ValidationProfile { get; init; }

/// <summary>
/// Gets or sets a callback invoked for each validation issue.
/// </summary>
/// <remarks>
/// Return false to abort parsing (strict mode behavior).
/// Return true to continue parsing (lenient mode behavior).
/// If not set, behavior is determined by ValidationProfile.DefaultBehavior.
/// </remarks>
public Func<ValidationIssue, bool>? ValidationCallback { get; init; }

/// <summary>
/// Gets or sets whether to collect validation issues in result.
/// </summary>
/// <remarks>
/// When true, issues are accumulated in DicomFile.ValidationResult.
/// When false, only callback is invoked (saves memory for streaming).
/// Default is true.
/// </remarks>
public bool CollectValidationIssues { get; init; } = true;
```

Update the static presets:

```csharp
public static DicomReaderOptions Strict { get; } = new()
{
    Preamble = FilePreambleHandling.Require,
    FileMetaInfo = FileMetaInfoHandling.Require,
    InvalidVR = InvalidVRHandling.Throw,
    MaxSequenceDepth = 128,
    MaxTotalItems = 100_000,
    ValidationProfile = ValidationProfile.Strict,
    CollectValidationIssues = true
};

public static DicomReaderOptions Lenient { get; } = new()
{
    Preamble = FilePreambleHandling.Optional,
    FileMetaInfo = FileMetaInfoHandling.Optional,
    InvalidVR = InvalidVRHandling.MapToUN,
    MaxSequenceDepth = 128,
    MaxTotalItems = 100_000,
    ValidationProfile = ValidationProfile.Lenient,
    CollectValidationIssues = true
};

public static DicomReaderOptions Permissive { get; } = new()
{
    Preamble = FilePreambleHandling.Ignore,
    FileMetaInfo = FileMetaInfoHandling.Ignore,
    InvalidVR = InvalidVRHandling.Preserve,
    MaxSequenceDepth = 256,
    MaxTotalItems = 500_000,
    ValidationProfile = ValidationProfile.Permissive,
    CollectValidationIssues = false  // Performance
};
```

**Update DicomFile.cs:**
Add ValidationResult property:

```csharp
using SharpDicom.Validation;

// Add to DicomFile class:

/// <summary>
/// Gets the validation result from parsing, if validation was enabled.
/// </summary>
/// <remarks>
/// Contains all validation issues collected during parsing when
/// DicomReaderOptions.CollectValidationIssues is true and a
/// ValidationProfile is configured.
/// </remarks>
public ValidationResult? ValidationResult { get; internal set; }
```
  </action>
  <verify>
    - `dotnet build` succeeds
    - DicomReaderOptions.ValidationProfile compiles
    - DicomFile.ValidationResult compiles
    - Preset options include validation configuration
  </verify>
  <done>
    - DicomReaderOptions has ValidationProfile, ValidationCallback, CollectValidationIssues
    - DicomReaderOptions.Strict uses ValidationProfile.Strict
    - DicomReaderOptions.Lenient uses ValidationProfile.Lenient
    - DicomReaderOptions.Permissive uses ValidationProfile.Permissive
    - DicomFile has ValidationResult property
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire validation into DicomFileReader and create tests</name>
  <files>
    src/SharpDicom/IO/DicomFileReader.cs
    tests/SharpDicom.Tests/Validation/ValidationProfileTests.cs
    tests/SharpDicom.Tests/Validation/ValidationIntegrationTests.cs
  </files>
  <action>
**Update DicomFileReader.cs:**
Add validation invocation during element parsing. After each element is created, if ValidationProfile is set:

1. Create ElementValidationContext from the element
2. Loop through profile.Rules
3. For each rule, call rule.Validate(context)
4. If issue returned:
   - If CollectValidationIssues, add to result
   - If ValidationCallback set, invoke it; if returns false, throw
   - If behavior is Validate and issue is Error, throw DicomDataException
5. Accumulate ValidationResult and set on DicomFile when parsing completes

Key integration points:
- In ReadElementAsync or equivalent, after element construction
- Pass ValidationResult to DicomFile.Open result
- Handle the abort-on-error behavior for strict mode

Note: Keep validation optional - if ValidationProfile is null, skip all validation for backward compatibility and performance.

**ValidationProfileTests.cs:**
Test:
- Strict preset has all rules
- Lenient preset has all rules with Warn behavior
- Permissive preset has only structural rules
- None preset has empty rules
- GetBehavior returns override when present
- GetBehavior returns default when no override

**ValidationIntegrationTests.cs:**
Test end-to-end validation scenarios:
- Parse file with invalid date, Strict mode -> throws
- Parse file with invalid date, Lenient mode -> ValidationResult contains issue
- Parse file with invalid date, Permissive mode -> no validation
- ValidationCallback invoked for each issue
- ValidationCallback returning false aborts parsing
- CollectValidationIssues=false skips collection but still invokes callback
- Valid file with Strict mode -> ValidationResult.IsValid = true
- Multiple issues accumulated in result
  </action>
  <verify>
    - `dotnet build` succeeds
    - `dotnet test --filter "FullyQualifiedName~Validation"` passes
    - Integration tests demonstrate Strict rejecting invalid files
    - Integration tests demonstrate Lenient collecting issues
  </verify>
  <done>
    - DicomFileReader invokes validation during element parsing
    - Validation respects profile behavior (Validate/Warn/Skip)
    - ValidationCallback receives each issue
    - Strict mode throws on Error-level issues
    - Lenient mode collects all issues
    - ValidationResult exposed on DicomFile after parsing
    - At least 20 integration tests
    - All tests pass on all target frameworks
  </done>
</task>

</tasks>

<verification>
- `dotnet build` succeeds with no warnings
- `dotnet test` passes all existing tests plus new validation tests
- Parsing with Strict options throws on invalid date
- Parsing with Lenient options returns ValidationResult with issues
- ValidationCallback is invoked for each issue
- DicomFile.ValidationResult is populated after parsing
</verification>

<success_criteria>
- ValidationBehavior enum has 3 values
- ValidationProfile has 4 static presets (Strict, Lenient, Permissive, None)
- DicomReaderOptions has ValidationProfile, ValidationCallback, CollectValidationIssues
- DicomReaderOptions presets updated with validation configuration
- DicomFile has ValidationResult property
- DicomFileReader invokes validation rules during parsing
- Strict mode rejects files with Error-level issues
- Lenient mode collects issues but continues
- Permissive mode skips most validation
- At least 25 validation-related unit tests
- All 529+ existing tests continue to pass
- Phase 8 success criteria from ROADMAP.md met:
  - [ ] Strict mode rejects bad files
  - [ ] Lenient mode recovers gracefully
  - [ ] Validation callback invoked
  - [ ] Issues reported with context
</success_criteria>

<output>
After completion, create `.planning/phases/08-validation/08-03-SUMMARY.md`
</output>
