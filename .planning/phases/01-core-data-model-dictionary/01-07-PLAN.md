---
phase: 01-core-data-model-dictionary
plan: 07
type: execute
wave: 4
depends_on: ["01-04", "01-06"]
files_modified:
  - tests/SharpDicom.Tests/Generators/DicomDictionaryGeneratorTests.cs
  - tests/SharpDicom.Tests/Generators/InMemoryAdditionalText.cs
  - tests/SharpDicom.Tests/SharpDicom.Tests.csproj
autonomous: true

must_haves:
  truths:
    - "Source generator tests verify generated code via Verify snapshots"
    - "Generator produces expected output for sample XML input"
    - "Generator handles malformed XML gracefully"
    - "All Phase 1 tests pass on net9.0"
  artifacts:
    - path: "tests/SharpDicom.Tests/Generators/DicomDictionaryGeneratorTests.cs"
      provides: "Generator snapshot tests"
      min_lines: 80
    - path: "tests/SharpDicom.Tests/Generators/InMemoryAdditionalText.cs"
      provides: "Test helper for additional files"
      min_lines: 15
  key_links:
    - from: "tests/SharpDicom.Tests/Generators/DicomDictionaryGeneratorTests.cs"
      to: "src/SharpDicom.Generators/DicomDictionaryGenerator.cs"
      via: "CSharpGeneratorDriver.Create"
      pattern: "CSharpGeneratorDriver\\.Create"
---

<objective>
Add comprehensive source generator tests using Verify.SourceGenerators and run full Phase 1 test suite.

Purpose: Validate that the source generator produces correct, compilable C# code and that the entire Phase 1 data model is working correctly.

Output:
- Generator snapshot tests using Verify.SourceGenerators
- Tests for edge cases and error handling
- Complete test coverage verification
- Phase 1 completion confirmation
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-data-model-dictionary/01-CONTEXT.md
@.planning/phases/01-core-data-model-dictionary/01-RESEARCH.md
@.planning/phases/01-core-data-model-dictionary/01-04-SUMMARY.md
@.planning/phases/01-core-data-model-dictionary/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Verify packages and setup</name>
  <files>
    tests/SharpDicom.Tests/SharpDicom.Tests.csproj
    Directory.Packages.props
    tests/SharpDicom.Tests/ModuleInitializer.cs
    tests/SharpDicom.Tests/Generators/InMemoryAdditionalText.cs
  </files>
  <action>
Add Verify.SourceGenerators testing infrastructure:

1. Update Directory.Packages.props to add:
   - Verify.SourceGenerators (latest)
   - Verify.NUnit (latest)
   - Microsoft.CodeAnalysis.CSharp (same version as generator uses)

2. Update tests/SharpDicom.Tests/SharpDicom.Tests.csproj:
   - Add PackageReference to Verify packages
   - Add ProjectReference to SharpDicom.Generators (for direct testing)

3. Create ModuleInitializer.cs for Verify setup:
```csharp
using System.Runtime.CompilerServices;

namespace SharpDicom.Tests;

public static class ModuleInitializer
{
    [ModuleInitializer]
    public static void Initialize()
    {
        VerifySourceGenerators.Initialize();
    }
}
```

4. Create InMemoryAdditionalText.cs helper:
```csharp
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;

namespace SharpDicom.Tests.Generators;

internal sealed class InMemoryAdditionalText : AdditionalText
{
    private readonly SourceText _text;

    public InMemoryAdditionalText(string path, string content)
    {
        Path = path;
        _text = SourceText.From(content, Encoding.UTF8);
    }

    public override string Path { get; }

    public override SourceText? GetText(CancellationToken cancellationToken = default)
        => _text;
}
```
  </action>
  <verify>
    dotnet build tests/SharpDicom.Tests/SharpDicom.Tests.csproj --configuration Release
  </verify>
  <done>
    Test project compiles with Verify packages and generator reference
  </done>
</task>

<task type="auto">
  <name>Task 2: Write generator snapshot tests</name>
  <files>
    tests/SharpDicom.Tests/Generators/DicomDictionaryGeneratorTests.cs
  </files>
  <action>
Write comprehensive generator tests using Verify:

```csharp
using System.Collections.Immutable;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using SharpDicom.Generators;
using VerifyNUnit;

namespace SharpDicom.Tests.Generators;

[TestFixture]
public class DicomDictionaryGeneratorTests
{
    [Test]
    public Task GeneratesTagsFromMinimalXml()
    {
        // Minimal Part 6-like XML with one tag
        var xml = """
            <?xml version="1.0" encoding="UTF-8"?>
            <book xmlns="http://docbook.org/ns/docbook">
              <chapter>
                <title>Registry of DICOM Data Elements</title>
                <table>
                  <tbody>
                    <tr>
                      <td>(0010,0020)</td>
                      <td>Patient ID</td>
                      <td>PatientID</td>
                      <td>LO</td>
                      <td>1</td>
                      <td></td>
                    </tr>
                  </tbody>
                </table>
              </chapter>
            </book>
            """;

        return VerifyGenerator(xml, "part06.xml");
    }

    [Test]
    public Task GeneratesMultiVRTag()
    {
        // Tag with multiple VRs (US or SS)
        var xml = """
            <?xml version="1.0" encoding="UTF-8"?>
            <book xmlns="http://docbook.org/ns/docbook">
              <chapter>
                <title>Registry of DICOM Data Elements</title>
                <table>
                  <tbody>
                    <tr>
                      <td>(0028,0106)</td>
                      <td>Smallest Image Pixel Value</td>
                      <td>SmallestImagePixelValue</td>
                      <td>US or SS</td>
                      <td>1</td>
                      <td></td>
                    </tr>
                  </tbody>
                </table>
              </chapter>
            </book>
            """;

        return VerifyGenerator(xml, "part06.xml");
    }

    [Test]
    public Task GeneratesRetiredTag()
    {
        // Retired tag (should be marked with IsRetired=true)
        var xml = """
            <?xml version="1.0" encoding="UTF-8"?>
            <book xmlns="http://docbook.org/ns/docbook">
              <chapter>
                <title>Registry of DICOM Data Elements</title>
                <table>
                  <tbody>
                    <tr>
                      <td>(0008,0041)</td>
                      <td>Data Set Subtype</td>
                      <td>DataSetSubtype</td>
                      <td>LO</td>
                      <td>1</td>
                      <td>RET</td>
                    </tr>
                  </tbody>
                </table>
              </chapter>
            </book>
            """;

        return VerifyGenerator(xml, "part06.xml");
    }

    [Test]
    public Task GeneratesUIDs()
    {
        // UID registry table
        var xml = """
            <?xml version="1.0" encoding="UTF-8"?>
            <book xmlns="http://docbook.org/ns/docbook">
              <chapter>
                <title>Registry of DICOM Unique Identifiers</title>
                <table>
                  <tbody>
                    <tr>
                      <td>1.2.840.10008.1.2</td>
                      <td>Implicit VR Little Endian</td>
                      <td>ImplicitVRLittleEndian</td>
                      <td>Transfer Syntax</td>
                      <td></td>
                    </tr>
                  </tbody>
                </table>
              </chapter>
            </book>
            """;

        return VerifyGenerator(xml, "part06.xml");
    }

    [Test]
    public Task HandlesMaskedTag()
    {
        // Masked tag (50xx,0010)
        var xml = """
            <?xml version="1.0" encoding="UTF-8"?>
            <book xmlns="http://docbook.org/ns/docbook">
              <chapter>
                <title>Registry of DICOM Data Elements</title>
                <table>
                  <tbody>
                    <tr>
                      <td>(50xx,0010)</td>
                      <td>Number of Points in ROI</td>
                      <td>NumberOfPointsInROI</td>
                      <td>US</td>
                      <td>1</td>
                      <td></td>
                    </tr>
                  </tbody>
                </table>
              </chapter>
            </book>
            """;

        return VerifyGenerator(xml, "part06.xml");
    }

    [Test]
    public Task HandlesEmptyXml()
    {
        var xml = """
            <?xml version="1.0" encoding="UTF-8"?>
            <book xmlns="http://docbook.org/ns/docbook">
            </book>
            """;

        return VerifyGenerator(xml, "part06.xml");
    }

    [Test]
    public Task ReportsDiagnosticForInvalidXml()
    {
        var xml = "not valid xml";

        return VerifyGenerator(xml, "part06.xml");
    }

    private static Task VerifyGenerator(string xmlContent, string fileName)
    {
        // Create compilation
        var compilation = CSharpCompilation.Create("TestAssembly",
            references: new[]
            {
                MetadataReference.CreateFromFile(typeof(object).Assembly.Location),
                MetadataReference.CreateFromFile(typeof(System.Linq.Enumerable).Assembly.Location)
            },
            options: new CSharpCompilationOptions(OutputKind.DynamicallyLinkedLibrary));

        // Create generator
        var generator = new DicomDictionaryGenerator();

        // Create driver with additional file
        var additionalText = new InMemoryAdditionalText(fileName, xmlContent);
        var driver = CSharpGeneratorDriver.Create(generator)
            .AddAdditionalTexts(ImmutableArray.Create<AdditionalText>(additionalText));

        // Run generator
        driver = driver.RunGenerators(compilation);

        // Verify snapshot
        return Verifier.Verify(driver);
    }
}
```

After running tests, the first run will create `.verified.cs` snapshot files.
Review them and commit as baseline.
  </action>
  <verify>
    dotnet test tests/SharpDicom.Tests --filter "FullyQualifiedName~DicomDictionaryGeneratorTests" --configuration Release
  </verify>
  <done>
    Generator tests pass with Verify snapshots, confirming correct code generation
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full Phase 1 test suite and verify</name>
  <files>
    tests/SharpDicom.Tests/Data/IntegrationTests.cs
  </files>
  <action>
Create final integration tests and run full test suite:

**IntegrationTests.cs**:
```csharp
namespace SharpDicom.Tests.Data;

[TestFixture]
public class IntegrationTests
{
    [Test]
    public void GeneratedDictionaryContainsExpectedTags()
    {
        // Verify dictionary has reasonable number of entries
        var patientId = DicomDictionary.Default.GetEntry(DicomTag.PatientId);
        Assert.That(patientId, Is.Not.Null, "PatientId should be in dictionary");

        var studyDate = DicomDictionary.Default.GetEntry(DicomTag.StudyDate);
        Assert.That(studyDate, Is.Not.Null, "StudyDate should be in dictionary");

        var modality = DicomDictionary.Default.GetEntry(DicomTag.Modality);
        Assert.That(modality, Is.Not.Null, "Modality should be in dictionary");
    }

    [Test]
    public void GeneratedUIDsAreAccessible()
    {
        // Verify well-known UIDs are generated
        Assert.That(DicomUID.ImplicitVRLittleEndian.ToString(),
            Is.EqualTo("1.2.840.10008.1.2"));
        Assert.That(DicomUID.ExplicitVRLittleEndian.ToString(),
            Is.EqualTo("1.2.840.10008.1.2.1"));
    }

    [Test]
    public void TransferSyntaxFromGeneratedUID()
    {
        var ts = TransferSyntax.FromUID(DicomUID.ImplicitVRLittleEndian);
        Assert.That(ts.IsKnown, Is.True);
        Assert.That(ts.IsExplicitVR, Is.False);
        Assert.That(ts.IsLittleEndian, Is.True);
    }

    [Test]
    public void DatasetWithGeneratedTags()
    {
        var dataset = new DicomDataset();

        // Build a typical DICOM dataset
        dataset.Add(new DicomStringElement(DicomTag.PatientId, DicomVR.LO,
            "PATIENT001"u8.ToArray()));
        dataset.Add(new DicomStringElement(DicomTag.PatientName, DicomVR.PN,
            "Doe^John"u8.ToArray()));
        dataset.Add(new DicomStringElement(DicomTag.StudyDate, DicomVR.DA,
            "20240115"u8.ToArray()));
        dataset.Add(new DicomStringElement(DicomTag.Modality, DicomVR.CS,
            "CT"u8.ToArray()));

        // Verify
        Assert.That(dataset.GetString(DicomTag.PatientId), Is.EqualTo("PATIENT001"));
        Assert.That(dataset.GetDate(DicomTag.StudyDate), Is.EqualTo(new DateOnly(2024, 1, 15)));
        Assert.That(dataset.Count, Is.EqualTo(4));

        // Verify sorted enumeration
        var tags = dataset.Select(e => e.Tag).ToList();
        Assert.That(tags, Is.Ordered);
    }

    [Test]
    public void DictionaryLookupPerformance()
    {
        // Simple performance sanity check (not a benchmark)
        var sw = System.Diagnostics.Stopwatch.StartNew();
        for (int i = 0; i < 100_000; i++)
        {
            _ = DicomDictionary.Default.GetEntry(DicomTag.PatientId);
        }
        sw.Stop();

        // Should be very fast (< 100ms for 100K lookups)
        Assert.That(sw.ElapsedMilliseconds, Is.LessThan(100),
            "Dictionary lookup should be O(1)");
    }
}
```

Run full test suite:
```bash
dotnet test tests/SharpDicom.Tests --configuration Release --verbosity normal
```

Verify:
- All tests pass
- No warnings in test output
- Generated code is being used correctly
  </action>
  <verify>
    dotnet test tests/SharpDicom.Tests --configuration Release --verbosity normal 2>&1 | tail -30
  </verify>
  <done>
    Full Phase 1 test suite passes, all components working together
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Full solution builds cleanly:
   ```bash
   dotnet build SharpDicom.sln --configuration Release
   ```

2. All tests pass:
   ```bash
   dotnet test tests/SharpDicom.Tests --configuration Release
   ```

3. Test count and coverage look reasonable:
   ```bash
   dotnet test --collect:"XPlat Code Coverage" --configuration Release
   ```

4. Verify snapshot files are committed for generator tests

5. Phase 1 requirements met:
   - DicomTag equality/comparison/hashing works
   - Source generator produces tag definitions
   - Dictionary lookup is O(1)
   - Unit tests pass
</verification>

<success_criteria>
- Generator snapshot tests pass with Verify
- Integration tests demonstrate generated code usage
- Full test suite passes on net9.0
- No build warnings
- Phase 1 success criteria from ROADMAP.md are met:
  - DicomTag equality/comparison/hashing works
  - Source generator produces ~4000 tag definitions
  - Dictionary lookup O(1) via FrozenDictionary
  - Unit tests pass on all TFMs
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-data-model-dictionary/01-07-SUMMARY.md`
</output>
