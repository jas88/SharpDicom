---
phase: 11-dimse-services
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SharpDicom/Network/Dimse/QueryRetrieveLevel.cs
  - src/SharpDicom/Network/Dimse/SubOperationProgress.cs
  - src/SharpDicom/Network/Dimse/DicomTransferProgress.cs
  - src/SharpDicom/Network/Dimse/DicomCommand.cs
  - src/SharpDicom/Data/DicomTag.WellKnown.cs
  - src/SharpDicom/Data/DicomUID.WellKnown.cs
  - tests/SharpDicom.Tests/Network/Dimse/DimseTypesTests.cs
autonomous: true

must_haves:
  truths:
    - "QueryRetrieveLevel enum exists with Patient, Study, Series, Image values"
    - "SubOperationProgress tracks Remaining, Completed, Failed, Warning counts"
    - "DicomTransferProgress reports BytesTransferred, TotalBytes, BytesPerSecond"
    - "DicomCommand can create C-FIND, C-MOVE, C-GET request/response commands"
    - "Well-known tags include MoveDestination, NumberOfRemainingSuboperations, etc."
  artifacts:
    - path: "src/SharpDicom/Network/Dimse/QueryRetrieveLevel.cs"
      provides: "Query/Retrieve level enum"
      contains: "enum QueryRetrieveLevel"
    - path: "src/SharpDicom/Network/Dimse/SubOperationProgress.cs"
      provides: "Sub-operation progress tracking"
      contains: "readonly record struct SubOperationProgress"
    - path: "src/SharpDicom/Network/Dimse/DicomTransferProgress.cs"
      provides: "Transfer progress tracking"
      contains: "readonly record struct DicomTransferProgress"
  key_links:
    - from: "DicomCommand factory methods"
      to: "QueryRetrieveLevel"
      via: "C-FIND/C-MOVE/C-GET request creation"
      pattern: "QueryRetrieveLevel"
---

<objective>
Create common DIMSE types and extend DicomCommand for C-FIND/C-MOVE/C-GET operations.

Purpose: Establish foundational types that all DIMSE service classes will use - query/retrieve levels, progress tracking structs, and command factory methods.

Output: QueryRetrieveLevel enum, SubOperationProgress struct, DicomTransferProgress struct, extended DicomCommand with factory methods for all remaining DIMSE-C commands.
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-dimse-services/11-CONTEXT.md
@.planning/phases/11-dimse-services/11-RESEARCH.md
@src/SharpDicom/Network/Dimse/DicomCommand.cs
@src/SharpDicom/Network/Dimse/CommandField.cs
@src/SharpDicom/Data/DicomTag.WellKnown.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: QueryRetrieveLevel enum and progress structs</name>
  <files>
    src/SharpDicom/Network/Dimse/QueryRetrieveLevel.cs
    src/SharpDicom/Network/Dimse/SubOperationProgress.cs
    src/SharpDicom/Network/Dimse/DicomTransferProgress.cs
  </files>
  <action>
Create QueryRetrieveLevel.cs:
- Enum with Patient, Study, Series, Image values
- Extension class QueryRetrieveLevelExtensions with:
  - ToDicomValue() returning "PATIENT", "STUDY", "SERIES", "IMAGE" strings
  - Parse(string value) returning enum from DICOM string
  - GetPatientRootSopClassUid(QueryRetrieveLevel level, CommandType type) - returns correct UID for FIND/MOVE/GET
  - GetStudyRootSopClassUid(QueryRetrieveLevel level, CommandType type) - returns correct UID

Create SubOperationProgress.cs (from 11-RESEARCH.md):
```csharp
/// <summary>
/// Tracks progress of sub-operations in C-MOVE and C-GET.
/// </summary>
/// <remarks>
/// Counts in Pending responses are cumulative per PS3.7, not incremental.
/// </remarks>
public readonly record struct SubOperationProgress(
    ushort Remaining,
    ushort Completed,
    ushort Failed,
    ushort Warning)
{
    public ushort Total => (ushort)(Remaining + Completed + Failed + Warning);
    public bool IsFinal => Remaining == 0;
    public bool HasErrors => Failed > 0;
    public bool HasWarnings => Warning > 0;
}
```

Create DicomTransferProgress.cs (from 11-CONTEXT.md):
```csharp
/// <summary>
/// Reports progress of data transfer operations (C-STORE).
/// </summary>
public readonly record struct DicomTransferProgress(
    long BytesTransferred,
    long TotalBytes,
    double BytesPerSecond)
{
    public double PercentComplete => TotalBytes > 0
        ? (double)BytesTransferred / TotalBytes * 100
        : 0;

    public TimeSpan? EstimatedTimeRemaining => BytesPerSecond > 0
        ? TimeSpan.FromSeconds((TotalBytes - BytesTransferred) / BytesPerSecond)
        : null;
}
```
  </action>
  <verify>
`dotnet build src/SharpDicom/SharpDicom.csproj` compiles without errors
  </verify>
  <done>
QueryRetrieveLevel enum exists with extension methods. SubOperationProgress and DicomTransferProgress structs created with calculated properties.
  </done>
</task>

<task type="auto">
  <name>Task 2: Well-known tags for DIMSE services</name>
  <files>
    src/SharpDicom/Data/DicomTag.WellKnown.cs
    src/SharpDicom/Data/DicomUID.WellKnown.cs
  </files>
  <action>
Add to DicomTag.WellKnown.cs (Group 0000 command tags per PS3.7 Annex E):
- MoveDestination (0000,0600) - AE VR - destination for C-MOVE
- Priority (0000,0700) - US VR - already may exist, verify
- NumberOfRemainingSuboperations (0000,1020) - US VR
- NumberOfCompletedSuboperations (0000,1021) - US VR
- NumberOfFailedSuboperations (0000,1022) - US VR
- NumberOfWarningSuboperations (0000,1023) - US VR

Add to DicomUID.WellKnown.cs (Q/R SOP Classes per PS3.4):
Patient Root:
- PatientRootQueryRetrieveInformationModelFind (1.2.840.10008.5.1.4.1.2.1.1)
- PatientRootQueryRetrieveInformationModelMove (1.2.840.10008.5.1.4.1.2.1.2)
- PatientRootQueryRetrieveInformationModelGet (1.2.840.10008.5.1.4.1.2.1.3)

Study Root:
- StudyRootQueryRetrieveInformationModelFind (1.2.840.10008.5.1.4.1.2.2.1)
- StudyRootQueryRetrieveInformationModelMove (1.2.840.10008.5.1.4.1.2.2.2)
- StudyRootQueryRetrieveInformationModelGet (1.2.840.10008.5.1.4.1.2.2.3)
  </action>
  <verify>
`dotnet build src/SharpDicom/SharpDicom.csproj` compiles without errors
Verify tags are accessible via DicomTag.MoveDestination, etc.
  </verify>
  <done>
All command tags for sub-operation tracking and Q/R SOP Class UIDs are defined in well-known files.
  </done>
</task>

<task type="auto">
  <name>Task 3: DicomCommand factory methods for C-FIND/C-MOVE/C-GET</name>
  <files>
    src/SharpDicom/Network/Dimse/DicomCommand.cs
  </files>
  <action>
Extend DicomCommand.cs with additional factory methods and properties:

Properties for sub-operation counts:
```csharp
/// <summary>Gets NumberOfRemainingSuboperations (0000,1020).</summary>
public ushort NumberOfRemainingSuboperations => GetUInt16(DicomTag.NumberOfRemainingSuboperations);

/// <summary>Gets NumberOfCompletedSuboperations (0000,1021).</summary>
public ushort NumberOfCompletedSuboperations => GetUInt16(DicomTag.NumberOfCompletedSuboperations);

/// <summary>Gets NumberOfFailedSuboperations (0000,1022).</summary>
public ushort NumberOfFailedSuboperations => GetUInt16(DicomTag.NumberOfFailedSuboperations);

/// <summary>Gets NumberOfWarningSuboperations (0000,1023).</summary>
public ushort NumberOfWarningSuboperations => GetUInt16(DicomTag.NumberOfWarningSuboperations);

/// <summary>Gets MoveDestination (0000,0600).</summary>
public string? MoveDestination => _dataset.GetString(DicomTag.MoveDestination)?.TrimEnd('\0', ' ');

/// <summary>Gets sub-operation progress from command response.</summary>
public SubOperationProgress GetSubOperationProgress() => new(
    NumberOfRemainingSuboperations,
    NumberOfCompletedSuboperations,
    NumberOfFailedSuboperations,
    NumberOfWarningSuboperations);
```

Factory methods:

CreateCFindRequest(ushort messageId, DicomUID sopClassUid, ushort priority = 0):
- Sets AffectedSOPClassUID, CommandField=0x0020, MessageID, Priority, CommandDataSetType=0x0102

CreateCFindResponse(ushort messageIdBeingRespondedTo, DicomUID sopClassUid, DicomStatus status):
- For Pending status, sets CommandDataSetType=0x0102 (has identifier)
- For final status, sets CommandDataSetType=0x0101 (no dataset)

CreateCMoveRequest(ushort messageId, DicomUID sopClassUid, string moveDestination, ushort priority = 0):
- Sets AffectedSOPClassUID, CommandField=0x0021, MessageID, Priority, MoveDestination, CommandDataSetType=0x0102

CreateCMoveResponse(ushort messageIdBeingRespondedTo, DicomUID sopClassUid, DicomStatus status, SubOperationProgress progress):
- Sets all sub-operation count fields from progress struct

CreateCGetRequest(ushort messageId, DicomUID sopClassUid, ushort priority = 0):
- Sets AffectedSOPClassUID, CommandField=0x0010, MessageID, Priority, CommandDataSetType=0x0102

CreateCGetResponse(ushort messageIdBeingRespondedTo, DicomUID sopClassUid, DicomStatus status, SubOperationProgress progress):
- Sets all sub-operation count fields from progress struct

CreateCCancelRequest(ushort messageIdBeingCancelled):
- Sets CommandField=0x0FFF, MessageIDBeingRespondedTo, CommandDataSetType=0x0101

Add helper:
```csharp
private static void AddAEElement(DicomDataset ds, DicomTag tag, string value)
{
    // AE is 16 bytes max, space padded to even length
    var bytes = System.Text.Encoding.ASCII.GetBytes(value.PadRight(value.Length % 2 == 0 ? value.Length : value.Length + 1));
    ds.Add(new DicomStringElement(tag, DicomVR.AE, bytes));
}
```
  </action>
  <verify>
`dotnet build src/SharpDicom/SharpDicom.csproj` compiles without errors
  </verify>
  <done>
DicomCommand has factory methods for all DIMSE-C request/response types and properties for sub-operation tracking.
  </done>
</task>

<task type="auto">
  <name>Task 4: Unit tests for DIMSE types</name>
  <files>
    tests/SharpDicom.Tests/Network/Dimse/DimseTypesTests.cs
  </files>
  <action>
Create DimseTypesTests.cs with tests for:

QueryRetrieveLevel tests:
- ToDicomValue returns correct strings
- Parse handles valid strings
- Parse throws on invalid input

SubOperationProgress tests:
- Total calculates correctly
- IsFinal true when Remaining=0
- HasErrors true when Failed>0
- HasWarnings true when Warning>0

DicomTransferProgress tests:
- PercentComplete calculates correctly
- PercentComplete returns 0 when TotalBytes=0
- EstimatedTimeRemaining calculates correctly
- EstimatedTimeRemaining returns null when BytesPerSecond=0

DicomCommand factory method tests:
- CreateCFindRequest produces valid command
- CreateCFindResponse with Pending has dataset
- CreateCFindResponse with Success has no dataset
- CreateCMoveRequest includes MoveDestination
- CreateCMoveResponse includes sub-operation counts
- CreateCGetRequest produces valid command
- CreateCGetResponse includes sub-operation counts
- CreateCCancelRequest produces valid command
- GetSubOperationProgress extracts counts correctly
  </action>
  <verify>
`dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj --filter "DimseTypesTests"` - all tests pass
  </verify>
  <done>
All new DIMSE types have comprehensive unit tests passing.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/SharpDicom/SharpDicom.csproj --configuration Release` - builds without errors or warnings
2. `dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj --filter "DimseTypesTests"` - all new tests pass
3. `dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj` - full test suite passes (no regressions)
</verification>

<success_criteria>
- QueryRetrieveLevel enum with all four levels and extension methods
- SubOperationProgress struct with calculated properties
- DicomTransferProgress struct with calculated properties
- DicomCommand extended with C-FIND/C-MOVE/C-GET/C-CANCEL factory methods
- All well-known tags and UIDs for Q/R operations defined
- Unit tests cover all new types and factory methods
- Zero compilation warnings
</success_criteria>

<output>
After completion, create `.planning/phases/11-dimse-services/11-01-SUMMARY.md`
</output>
