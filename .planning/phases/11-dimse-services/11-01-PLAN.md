---
phase: 11-dimse-services
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SharpDicom/Network/Dimse/QueryRetrieveLevel.cs
  - src/SharpDicom/Network/Dimse/SubOperationProgress.cs
  - src/SharpDicom/Network/Dimse/DicomTransferProgress.cs
  - src/SharpDicom/Network/Dimse/DicomCommand.cs
  - src/SharpDicom/Network/DicomClient.cs
  - src/SharpDicom/Data/DicomTag.WellKnown.cs
  - src/SharpDicom/Data/DicomUID.WellKnown.cs
  - tests/SharpDicom.Tests/Network/Dimse/DimseTypesTests.cs
autonomous: true

must_haves:
  truths:
    - "QueryRetrieveLevel enum exists with Patient, Study, Series, Image values"
    - "SubOperationProgress tracks Remaining, Completed, Failed, Warning counts"
    - "DicomTransferProgress reports BytesTransferred, TotalBytes, BytesPerSecond"
    - "DicomCommand can create C-FIND, C-MOVE, C-GET request/response commands"
    - "Well-known tags include MoveDestination, NumberOfRemainingSuboperations, etc."
    - "DicomClient exposes internal DIMSE primitive methods for SCU services"
  artifacts:
    - path: "src/SharpDicom/Network/Dimse/QueryRetrieveLevel.cs"
      provides: "Query/Retrieve level enum"
      contains: "enum QueryRetrieveLevel"
    - path: "src/SharpDicom/Network/Dimse/SubOperationProgress.cs"
      provides: "Sub-operation progress tracking"
      contains: "readonly record struct SubOperationProgress"
    - path: "src/SharpDicom/Network/Dimse/DicomTransferProgress.cs"
      provides: "Transfer progress tracking"
      contains: "readonly record struct DicomTransferProgress"
    - path: "src/SharpDicom/Network/DicomClient.cs"
      provides: "DIMSE primitive methods for SCU services"
      exports: ["SendDimseRequestAsync", "ReceiveDimseResponseAsync", "SendCCancelAsync"]
  key_links:
    - from: "DicomCommand factory methods"
      to: "QueryRetrieveLevel"
      via: "C-FIND/C-MOVE/C-GET request creation"
      pattern: "QueryRetrieveLevel"
    - from: "SCU service classes"
      to: "DicomClient DIMSE primitives"
      via: "SendDimseRequestAsync and ReceiveDimseResponseAsync"
      pattern: "SendDimseRequestAsync|ReceiveDimseResponseAsync"
---

<objective>
Create common DIMSE types and extend DicomCommand for C-FIND/C-MOVE/C-GET operations.

Purpose: Establish foundational types that all DIMSE service classes will use - query/retrieve levels, progress tracking structs, and command factory methods.

Output: QueryRetrieveLevel enum, SubOperationProgress struct, DicomTransferProgress struct, extended DicomCommand with factory methods for all remaining DIMSE-C commands.
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-dimse-services/11-CONTEXT.md
@.planning/phases/11-dimse-services/11-RESEARCH.md
@src/SharpDicom/Network/Dimse/DicomCommand.cs
@src/SharpDicom/Network/Dimse/CommandField.cs
@src/SharpDicom/Data/DicomTag.WellKnown.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: QueryRetrieveLevel enum and progress structs</name>
  <files>
    src/SharpDicom/Network/Dimse/QueryRetrieveLevel.cs
    src/SharpDicom/Network/Dimse/SubOperationProgress.cs
    src/SharpDicom/Network/Dimse/DicomTransferProgress.cs
  </files>
  <action>
Create QueryRetrieveLevel.cs:
- Enum with Patient, Study, Series, Image values
- Extension class QueryRetrieveLevelExtensions with:
  - ToDicomValue() returning "PATIENT", "STUDY", "SERIES", "IMAGE" strings
  - Parse(string value) returning enum from DICOM string
  - GetPatientRootSopClassUid(QueryRetrieveLevel level, CommandType type) - returns correct UID for FIND/MOVE/GET
  - GetStudyRootSopClassUid(QueryRetrieveLevel level, CommandType type) - returns correct UID

Create SubOperationProgress.cs (from 11-RESEARCH.md):
```csharp
/// <summary>
/// Tracks progress of sub-operations in C-MOVE and C-GET.
/// </summary>
/// <remarks>
/// Counts in Pending responses are cumulative per PS3.7, not incremental.
/// </remarks>
public readonly record struct SubOperationProgress(
    ushort Remaining,
    ushort Completed,
    ushort Failed,
    ushort Warning)
{
    public ushort Total => (ushort)(Remaining + Completed + Failed + Warning);
    public bool IsFinal => Remaining == 0;
    public bool HasErrors => Failed > 0;
    public bool HasWarnings => Warning > 0;
}
```

Create DicomTransferProgress.cs (from 11-CONTEXT.md):
```csharp
/// <summary>
/// Reports progress of data transfer operations (C-STORE).
/// </summary>
public readonly record struct DicomTransferProgress(
    long BytesTransferred,
    long TotalBytes,
    double BytesPerSecond)
{
    public double PercentComplete => TotalBytes > 0
        ? (double)BytesTransferred / TotalBytes * 100
        : 0;

    public TimeSpan? EstimatedTimeRemaining => BytesPerSecond > 0
        ? TimeSpan.FromSeconds((TotalBytes - BytesTransferred) / BytesPerSecond)
        : null;
}
```
  </action>
  <verify>
`dotnet build src/SharpDicom/SharpDicom.csproj` compiles without errors
  </verify>
  <done>
QueryRetrieveLevel enum exists with extension methods. SubOperationProgress and DicomTransferProgress structs created with calculated properties.
  </done>
</task>

<task type="auto">
  <name>Task 2: Well-known tags for DIMSE services</name>
  <files>
    src/SharpDicom/Data/DicomTag.WellKnown.cs
    src/SharpDicom/Data/DicomUID.WellKnown.cs
  </files>
  <action>
Add to DicomTag.WellKnown.cs (Group 0000 command tags per PS3.7 Annex E):
- MoveDestination (0000,0600) - AE VR - destination for C-MOVE
- Priority (0000,0700) - US VR - already may exist, verify
- NumberOfRemainingSuboperations (0000,1020) - US VR
- NumberOfCompletedSuboperations (0000,1021) - US VR
- NumberOfFailedSuboperations (0000,1022) - US VR
- NumberOfWarningSuboperations (0000,1023) - US VR

Add to DicomUID.WellKnown.cs (Q/R SOP Classes per PS3.4):
Patient Root:
- PatientRootQueryRetrieveInformationModelFind (1.2.840.10008.5.1.4.1.2.1.1)
- PatientRootQueryRetrieveInformationModelMove (1.2.840.10008.5.1.4.1.2.1.2)
- PatientRootQueryRetrieveInformationModelGet (1.2.840.10008.5.1.4.1.2.1.3)

Study Root:
- StudyRootQueryRetrieveInformationModelFind (1.2.840.10008.5.1.4.1.2.2.1)
- StudyRootQueryRetrieveInformationModelMove (1.2.840.10008.5.1.4.1.2.2.2)
- StudyRootQueryRetrieveInformationModelGet (1.2.840.10008.5.1.4.1.2.2.3)
  </action>
  <verify>
`dotnet build src/SharpDicom/SharpDicom.csproj` compiles without errors
Verify tags are accessible via DicomTag.MoveDestination, etc.
  </verify>
  <done>
All command tags for sub-operation tracking and Q/R SOP Class UIDs are defined in well-known files.
  </done>
</task>

<task type="auto">
  <name>Task 3: DicomCommand factory methods for C-FIND/C-MOVE/C-GET</name>
  <files>
    src/SharpDicom/Network/Dimse/DicomCommand.cs
  </files>
  <action>
Extend DicomCommand.cs with additional factory methods and properties:

Properties for sub-operation counts:
```csharp
/// <summary>Gets NumberOfRemainingSuboperations (0000,1020).</summary>
public ushort NumberOfRemainingSuboperations => GetUInt16(DicomTag.NumberOfRemainingSuboperations);

/// <summary>Gets NumberOfCompletedSuboperations (0000,1021).</summary>
public ushort NumberOfCompletedSuboperations => GetUInt16(DicomTag.NumberOfCompletedSuboperations);

/// <summary>Gets NumberOfFailedSuboperations (0000,1022).</summary>
public ushort NumberOfFailedSuboperations => GetUInt16(DicomTag.NumberOfFailedSuboperations);

/// <summary>Gets NumberOfWarningSuboperations (0000,1023).</summary>
public ushort NumberOfWarningSuboperations => GetUInt16(DicomTag.NumberOfWarningSuboperations);

/// <summary>Gets MoveDestination (0000,0600).</summary>
public string? MoveDestination => _dataset.GetString(DicomTag.MoveDestination)?.TrimEnd('\0', ' ');

/// <summary>Gets sub-operation progress from command response.</summary>
public SubOperationProgress GetSubOperationProgress() => new(
    NumberOfRemainingSuboperations,
    NumberOfCompletedSuboperations,
    NumberOfFailedSuboperations,
    NumberOfWarningSuboperations);
```

Factory methods:

CreateCFindRequest(ushort messageId, DicomUID sopClassUid, ushort priority = 0):
- Sets AffectedSOPClassUID, CommandField=0x0020, MessageID, Priority, CommandDataSetType=0x0102

CreateCFindResponse(ushort messageIdBeingRespondedTo, DicomUID sopClassUid, DicomStatus status):
- For Pending status, sets CommandDataSetType=0x0102 (has identifier)
- For final status, sets CommandDataSetType=0x0101 (no dataset)

CreateCMoveRequest(ushort messageId, DicomUID sopClassUid, string moveDestination, ushort priority = 0):
- Sets AffectedSOPClassUID, CommandField=0x0021, MessageID, Priority, MoveDestination, CommandDataSetType=0x0102

CreateCMoveResponse(ushort messageIdBeingRespondedTo, DicomUID sopClassUid, DicomStatus status, SubOperationProgress progress):
- Sets all sub-operation count fields from progress struct

CreateCGetRequest(ushort messageId, DicomUID sopClassUid, ushort priority = 0):
- Sets AffectedSOPClassUID, CommandField=0x0010, MessageID, Priority, CommandDataSetType=0x0102

CreateCGetResponse(ushort messageIdBeingRespondedTo, DicomUID sopClassUid, DicomStatus status, SubOperationProgress progress):
- Sets all sub-operation count fields from progress struct

CreateCCancelRequest(ushort messageIdBeingCancelled):
- Sets CommandField=0x0FFF, MessageIDBeingRespondedTo, CommandDataSetType=0x0101

Add helper:
```csharp
private static void AddAEElement(DicomDataset ds, DicomTag tag, string value)
{
    // AE is 16 bytes max, space padded to even length
    var bytes = System.Text.Encoding.ASCII.GetBytes(value.PadRight(value.Length % 2 == 0 ? value.Length : value.Length + 1));
    ds.Add(new DicomStringElement(tag, DicomVR.AE, bytes));
}
```
  </action>
  <verify>
`dotnet build src/SharpDicom/SharpDicom.csproj` compiles without errors
  </verify>
  <done>
DicomCommand has factory methods for all DIMSE-C request/response types and properties for sub-operation tracking.
  </done>
</task>

<task type="auto">
  <name>Task 4: DicomClient DIMSE primitive methods</name>
  <files>
    src/SharpDicom/Network/DicomClient.cs
  </files>
  <action>
Extend DicomClient.cs with internal DIMSE primitive methods for SCU services.

Phase 10 DicomClient has private methods SendDimseCommandAsync and ReceiveDimseCommandAsync.
These need to be extended and exposed as internal methods for SCU services to use.

Add the following internal methods:

```csharp
/// <summary>
/// Sends a DIMSE request with optional data PDV.
/// </summary>
/// <param name="presentationContextId">Presentation context ID to use.</param>
/// <param name="command">The DIMSE command to send.</param>
/// <param name="dataset">Optional dataset to send (identifier, data, etc.).</param>
/// <param name="ct">Cancellation token.</param>
/// <remarks>
/// Command is always encoded as Implicit VR Little Endian per PS3.7.
/// Dataset uses the negotiated transfer syntax for the presentation context.
/// </remarks>
internal async ValueTask SendDimseRequestAsync(
    byte presentationContextId,
    DicomCommand command,
    DicomDataset? dataset,
    CancellationToken ct)
{
    // Send command PDV (Implicit VR LE, isCommand=true, isLastFragment depends on dataset)
    await SendDimseCommandAsync(presentationContextId, command, ct).ConfigureAwait(false);

    // If dataset present, serialize with negotiated TS and send as data PDVs
    if (dataset != null)
    {
        await SendDatasetAsync(presentationContextId, dataset, ct).ConfigureAwait(false);
    }
}

/// <summary>
/// Receives a DIMSE response with optional data PDV.
/// </summary>
/// <param name="ct">Cancellation token.</param>
/// <returns>Tuple of (command, optional dataset).</returns>
internal async ValueTask<(DicomCommand command, DicomDataset? dataset)> ReceiveDimseResponseAsync(
    CancellationToken ct)
{
    // Receive command PDV
    var command = await ReceiveDimseCommandAsync(ct).ConfigureAwait(false);

    // Check if dataset follows (CommandDataSetType != 0x0101)
    DicomDataset? dataset = null;
    if (command.HasDataset)
    {
        dataset = await ReceiveDatasetAsync(ct).ConfigureAwait(false);
    }

    return (command, dataset);
}

/// <summary>
/// Sends a C-CANCEL request to cancel an in-progress operation.
/// </summary>
/// <param name="messageIdBeingCancelled">Message ID of the operation to cancel.</param>
/// <param name="ct">Cancellation token.</param>
internal async ValueTask SendCCancelAsync(ushort messageIdBeingCancelled, CancellationToken ct)
{
    var context = GetFirstAcceptedContext(); // Get any accepted context
    var cancel = DicomCommand.CreateCCancelRequest(messageIdBeingCancelled);
    await SendDimseCommandAsync(context.Id, cancel, ct).ConfigureAwait(false);
}
```

Also add helper methods:

```csharp
/// <summary>
/// Sends a dataset as data PDVs.
/// </summary>
private async ValueTask SendDatasetAsync(byte pcid, DicomDataset dataset, CancellationToken ct)
{
    // Get negotiated transfer syntax for this presentation context
    var context = _association!.GetAcceptedContext(pcid);
    var ts = context.TransferSyntax;

    // Serialize dataset (using negotiated TS, NOT Implicit VR LE)
    var dataBytes = SerializeDataset(dataset, ts);

    // Fragment into PDVs respecting MaxPduLength
    // Set isLastFragment=true on final PDV
    await SendPdvFragmentsAsync(pcid, isCommand: false, dataBytes, ct).ConfigureAwait(false);
}

/// <summary>
/// Receives a dataset from data PDVs.
/// </summary>
private async ValueTask<DicomDataset> ReceiveDatasetAsync(CancellationToken ct)
{
    // Receive PDVs until last fragment flag set
    // Parse using presentation context transfer syntax
    // Return assembled dataset
}
```

Key implementation notes:
1. Command PDV: Always Implicit VR Little Endian (PS3.7 Section 9.3.1)
2. Data PDV: Uses negotiated transfer syntax of presentation context (NOT Implicit VR LE)
3. PDV fragmentation must respect MaxPduLength from association
4. Last fragment flag (0x02 in PDV header) must be set correctly
5. These methods are internal so SCU service classes can access them
  </action>
  <verify>
`dotnet build src/SharpDicom/SharpDicom.csproj` compiles without errors
  </verify>
  <done>
DicomClient has internal SendDimseRequestAsync, ReceiveDimseResponseAsync, and SendCCancelAsync methods that SCU services can use.
  </done>
</task>

<task type="auto">
  <name>Task 5: Unit tests for DIMSE types</name>
  <files>
    tests/SharpDicom.Tests/Network/Dimse/DimseTypesTests.cs
  </files>
  <action>
Create DimseTypesTests.cs with tests for:

QueryRetrieveLevel tests:
- ToDicomValue returns correct strings
- Parse handles valid strings
- Parse throws on invalid input

SubOperationProgress tests:
- Total calculates correctly
- IsFinal true when Remaining=0
- HasErrors true when Failed>0
- HasWarnings true when Warning>0

DicomTransferProgress tests:
- PercentComplete calculates correctly
- PercentComplete returns 0 when TotalBytes=0
- EstimatedTimeRemaining calculates correctly
- EstimatedTimeRemaining returns null when BytesPerSecond=0

DicomCommand factory method tests:
- CreateCFindRequest produces valid command
- CreateCFindResponse with Pending has dataset
- CreateCFindResponse with Success has no dataset
- CreateCMoveRequest includes MoveDestination
- CreateCMoveResponse includes sub-operation counts
- CreateCGetRequest produces valid command
- CreateCGetResponse includes sub-operation counts
- CreateCCancelRequest produces valid command
- GetSubOperationProgress extracts counts correctly
  </action>
  <verify>
`dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj --filter "DimseTypesTests"` - all tests pass
  </verify>
  <done>
All new DIMSE types have comprehensive unit tests passing.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/SharpDicom/SharpDicom.csproj --configuration Release` - builds without errors or warnings
2. `dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj --filter "DimseTypesTests"` - all new tests pass
3. `dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj` - full test suite passes (no regressions)
</verification>

<success_criteria>
- QueryRetrieveLevel enum with all four levels and extension methods
- SubOperationProgress struct with calculated properties
- DicomTransferProgress struct with calculated properties
- DicomCommand extended with C-FIND/C-MOVE/C-GET/C-CANCEL factory methods
- All well-known tags and UIDs for Q/R operations defined
- Unit tests cover all new types and factory methods
- Zero compilation warnings
</success_criteria>

<output>
After completion, create `.planning/phases/11-dimse-services/11-01-SUMMARY.md`
</output>
