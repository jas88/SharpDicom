---
phase: 11-dimse-services
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/SharpDicom/Network/Dimse/Services/CStoreScu.cs
  - src/SharpDicom/Network/Dimse/Services/CStoreOptions.cs
  - src/SharpDicom/Network/Dimse/Services/CStoreResponse.cs
  - src/SharpDicom/Network/DicomClient.cs
  - tests/SharpDicom.Tests/Network/Dimse/CStoreScuTests.cs
autonomous: true

must_haves:
  truths:
    - "CStoreScu can send DicomFile to remote AE"
    - "CStoreScu can stream from Stream without full buffering"
    - "CStoreScu reports progress via IProgress<DicomTransferProgress>"
    - "CStoreScu handles CancellationToken correctly"
  artifacts:
    - path: "src/SharpDicom/Network/Dimse/Services/CStoreScu.cs"
      provides: "C-STORE SCU service class"
      contains: "class CStoreScu"
    - path: "src/SharpDicom/Network/Dimse/Services/CStoreOptions.cs"
      provides: "C-STORE SCU options"
      contains: "class CStoreOptions"
    - path: "src/SharpDicom/Network/Dimse/Services/CStoreResponse.cs"
      provides: "C-STORE response wrapper"
      contains: "class CStoreResponse"
  key_links:
    - from: "CStoreScu"
      to: "DicomClient"
      via: "network send methods"
      pattern: "DicomClient|_client"
    - from: "CStoreScu.SendAsync"
      to: "DicomTransferProgress"
      via: "IProgress callback"
      pattern: "IProgress<DicomTransferProgress>"
---

<objective>
Implement C-STORE SCU service for sending DICOM files to remote application entities.

Purpose: Enable SharpDicom to act as a Storage SCU - send DICOM images and other composite objects to PACS, workstations, or other DICOM storage providers.

Output: CStoreScu class with multiple SendAsync overloads for DicomFile, Stream, and DicomDataset+IPixelDataSource. Progress reporting via IProgress and cancellation support.
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-dimse-services/11-CONTEXT.md
@.planning/phases/11-dimse-services/11-RESEARCH.md
@.planning/phases/10-network-foundation/10-05-SUMMARY.md
@src/SharpDicom/Network/DicomClient.cs
@src/SharpDicom/Network/Dimse/DicomCommand.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: CStoreOptions and CStoreResponse types</name>
  <files>
    src/SharpDicom/Network/Dimse/Services/CStoreOptions.cs
    src/SharpDicom/Network/Dimse/Services/CStoreResponse.cs
  </files>
  <action>
Create Services subdirectory under Network/Dimse/.

Create CStoreOptions.cs:
```csharp
namespace SharpDicom.Network.Dimse.Services
{
    /// <summary>
    /// Options for C-STORE SCU operations.
    /// </summary>
    public sealed class CStoreOptions
    {
        /// <summary>
        /// Default C-STORE options.
        /// </summary>
        public static CStoreOptions Default { get; } = new();

        /// <summary>
        /// Gets or sets the operation timeout. Default is 30 seconds.
        /// </summary>
        public TimeSpan Timeout { get; set; } = TimeSpan.FromSeconds(30);

        /// <summary>
        /// Gets or sets the priority for the store operation. Default is MEDIUM (0).
        /// </summary>
        /// <remarks>
        /// 0 = MEDIUM, 1 = HIGH, 2 = LOW per DICOM PS3.7.
        /// </remarks>
        public ushort Priority { get; set; } = 0;

        /// <summary>
        /// Gets or sets the maximum number of retries on transient failures. Default is 0 (no retry).
        /// </summary>
        public int MaxRetries { get; set; } = 0;

        /// <summary>
        /// Gets or sets the initial delay between retries. Default is 1 second.
        /// </summary>
        /// <remarks>
        /// Delay doubles with each retry (exponential backoff).
        /// </remarks>
        public TimeSpan RetryDelay { get; set; } = TimeSpan.FromSeconds(1);

        /// <summary>
        /// Gets or sets whether to report progress. Default is true.
        /// </summary>
        public bool ReportProgress { get; set; } = true;
    }
}
```

Create CStoreResponse.cs:
```csharp
namespace SharpDicom.Network.Dimse.Services
{
    /// <summary>
    /// Represents the response from a C-STORE operation.
    /// </summary>
    public sealed class CStoreResponse
    {
        /// <summary>
        /// Initializes a new instance of the <see cref="CStoreResponse"/> class.
        /// </summary>
        public CStoreResponse(DicomStatus status, DicomUID sopClassUid, DicomUID sopInstanceUid, string? errorComment = null)
        {
            Status = status;
            SOPClassUID = sopClassUid;
            SOPInstanceUID = sopInstanceUid;
            ErrorComment = errorComment;
        }

        /// <summary>Gets the DIMSE status.</summary>
        public DicomStatus Status { get; }

        /// <summary>Gets the SOP Class UID.</summary>
        public DicomUID SOPClassUID { get; }

        /// <summary>Gets the SOP Instance UID.</summary>
        public DicomUID SOPInstanceUID { get; }

        /// <summary>Gets the error comment if status is not success.</summary>
        public string? ErrorComment { get; }

        /// <summary>Gets whether the operation was successful.</summary>
        public bool IsSuccess => Status.IsSuccess;

        /// <summary>Gets whether the operation had a warning.</summary>
        public bool IsWarning => Status.IsWarning;
    }
}
```
  </action>
  <verify>
`dotnet build src/SharpDicom/SharpDicom.csproj` compiles without errors
  </verify>
  <done>
CStoreOptions with timeout, priority, retry settings and CStoreResponse wrapper created.
  </done>
</task>

<task type="auto">
  <name>Task 2: CStoreScu service class</name>
  <files>
    src/SharpDicom/Network/Dimse/Services/CStoreScu.cs
  </files>
  <action>
Create CStoreScu.cs implementing C-STORE SCU per 11-CONTEXT.md API patterns:

```csharp
namespace SharpDicom.Network.Dimse.Services
{
    /// <summary>
    /// C-STORE Service Class User (SCU) for sending DICOM files to remote AEs.
    /// </summary>
    public sealed class CStoreScu
    {
        private readonly DicomClient _client;
        private readonly CStoreOptions _options;
        private int _messageIdCounter;

        /// <summary>
        /// Initializes a new instance of the <see cref="CStoreScu"/> class.
        /// </summary>
        /// <param name="client">Connected DicomClient with active association.</param>
        /// <param name="options">Optional store options.</param>
        public CStoreScu(DicomClient client, CStoreOptions? options = null)
        {
            _client = client ?? throw new ArgumentNullException(nameof(client));
            _options = options ?? CStoreOptions.Default;
        }

        /// <summary>
        /// Sends a DICOM file to the remote AE.
        /// </summary>
        public ValueTask<CStoreResponse> SendAsync(
            DicomFile file,
            IProgress<DicomTransferProgress>? progress = null,
            CancellationToken ct = default)
        {
            // Extract SOPClassUID and SOPInstanceUID from file metadata
            // Serialize dataset and send via P-DATA
            // Implementation details...
        }

        /// <summary>
        /// Sends DICOM data from a stream to the remote AE.
        /// </summary>
        /// <remarks>
        /// Stream is read in chunks to avoid full buffering. File Meta Information
        /// must be present at the beginning of the stream.
        /// </remarks>
        public ValueTask<CStoreResponse> SendAsync(
            Stream stream,
            IProgress<DicomTransferProgress>? progress = null,
            CancellationToken ct = default)
        {
            // Read FMI to get SOPClassUID, SOPInstanceUID, TransferSyntax
            // Stream dataset in chunks via P-DATA
        }

        /// <summary>
        /// Sends a dataset with separate pixel data source to the remote AE.
        /// </summary>
        /// <remarks>
        /// Use for transcoding scenarios where metadata and pixels are separate.
        /// </remarks>
        public ValueTask<CStoreResponse> SendAsync(
            DicomDataset dataset,
            IPixelDataSource? pixels,
            IProgress<DicomTransferProgress>? progress = null,
            CancellationToken ct = default)
        {
            // Build command, serialize dataset, stream pixels
        }

        private ushort NextMessageId() => (ushort)Interlocked.Increment(ref _messageIdCounter);
    }
}
```

Implementation requirements:
1. Build C-STORE-RQ command using DicomCommand.CreateCStoreRequest
2. Serialize dataset to presentation context transfer syntax (not Implicit VR LE)
3. Fragment data into P-DATA PDVs respecting MaxPduLength
4. Set Last fragment flag (0x02) on final PDV of dataset
5. Wait for C-STORE-RSP
6. Report progress at PDU boundaries
7. Handle timeout via CancellationTokenSource.CancelAfter
8. Support retry with exponential backoff on retryable failures (0xA7xx Out of Resources)

Progress reporting:
- Calculate total bytes from dataset size or stream length
- Report after each PDU write
- Calculate rate using stopwatch

Note: DicomClient needs extension methods or internal methods for sending raw P-DATA. Check existing DicomClient.cs for available infrastructure. May need to add SendPDataAsync and ReceiveDimseResponseAsync methods.
  </action>
  <verify>
`dotnet build src/SharpDicom/SharpDicom.csproj` compiles without errors
  </verify>
  <done>
CStoreScu class with all three SendAsync overloads implemented. Progress reporting and cancellation supported.
  </done>
</task>

<task type="auto">
  <name>Task 3: Unit tests for CStoreScu</name>
  <files>
    tests/SharpDicom.Tests/Network/Dimse/CStoreScuTests.cs
  </files>
  <action>
Create CStoreScuTests.cs with tests:

Constructor tests:
- Null client throws ArgumentNullException
- Default options used when null
- Custom options stored correctly

CStoreOptions tests:
- Default values correct (30s timeout, priority 0, no retry)
- Properties settable

CStoreResponse tests:
- IsSuccess true for 0x0000 status
- IsWarning true for 0xB000 status
- Properties set correctly from constructor

Command creation tests (verify commands built correctly):
- C-STORE-RQ includes SOPClassUID
- C-STORE-RQ includes SOPInstanceUID
- C-STORE-RQ includes priority
- Message IDs increment

Note: Full network integration tests will be in Plan 11-07. These are unit tests verifying internal logic.
  </action>
  <verify>
`dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj --filter "CStoreScuTests"` - all tests pass
  </verify>
  <done>
Unit tests for CStoreScu verify command creation, options handling, and response interpretation.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/SharpDicom/SharpDicom.csproj --configuration Release` - builds without errors or warnings
2. `dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj --filter "CStoreScuTests"` - all new tests pass
3. `dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj` - full test suite passes
</verification>

<success_criteria>
- CStoreScu class exists with SendAsync overloads for DicomFile, Stream, and DicomDataset+IPixelDataSource
- CStoreOptions configures timeout, priority, and retry behavior
- CStoreResponse wraps status and SOP UIDs
- Progress reporting via IProgress<DicomTransferProgress>
- Cancellation via CancellationToken
- Unit tests pass for command creation and response handling
</success_criteria>

<output>
After completion, create `.planning/phases/11-dimse-services/11-02-SUMMARY.md`
</output>
