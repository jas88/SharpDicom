---
phase: 03-implicit-vr-sequences
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SharpDicom/IO/SequenceParser.cs
  - src/SharpDicom/Data/DicomDataset.cs
  - tests/SharpDicom.Tests/IO/SequenceParsingTests.cs
autonomous: true

must_haves:
  truths:
    - "Sequences contain nested DicomDataset items"
    - "Undefined length sequences parse until SequenceDelimitationItem"
    - "Defined length sequences parse bytes within length boundary"
    - "Nested sequences parse recursively to configurable depth"
    - "Empty sequences return empty Items collection (not null)"
  artifacts:
    - path: "src/SharpDicom/IO/SequenceParser.cs"
      provides: "Sequence and item parsing with depth guard"
      contains: "ParseSequence"
      min_lines: 150
    - path: "tests/SharpDicom.Tests/IO/SequenceParsingTests.cs"
      provides: "Comprehensive sequence parsing tests"
      min_lines: 200
  key_links:
    - from: "SequenceParser.ParseSequence"
      to: "DicomSequence"
      via: "returns parsed sequence"
      pattern: "new DicomSequence"
    - from: "SequenceParser.ParseItem"
      to: "DicomDataset"
      via: "returns item dataset"
      pattern: "new DicomDataset"
---

<objective>
Implement sequence parsing with support for defined length, undefined length, and nested sequences.

Purpose: DICOM sequences (SQ VR) contain nested datasets. This plan implements the core sequence parsing logic using an explicit stack (per CONTEXT.md decision) to avoid stack overflow on deeply nested files.

Output:
- SequenceParser class with ParseSequence and ParseItem methods
- Depth guard with configurable limit
- Parent reference on items (per CONTEXT.md)
- Comprehensive tests for all sequence scenarios
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-implicit-vr-sequences/03-RESEARCH.md
@.planning/phases/03-implicit-vr-sequences/03-CONTEXT.md
@src/SharpDicom/IO/DicomStreamReader.cs
@src/SharpDicom/Data/DicomSequence.cs
@src/SharpDicom/Data/DicomDataset.cs
@src/SharpDicom/Data/DicomTag.WellKnown.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Parent property to DicomDataset</name>
  <files>src/SharpDicom/Data/DicomDataset.cs</files>
  <action>
Per CONTEXT.md decision, add parent reference to DicomDataset:

1. Add a Parent property (DicomDataset?) that references the parent dataset for sequence items
2. Property should be settable internally but read-only externally (internal set)
3. For root datasets, Parent is null
4. Update ToOwned() to NOT copy parent reference (owned copy has no parent)
5. Add XML documentation explaining the property is set for sequence items

This enables context inheritance for nested sequences (BitsAllocated, PixelRepresentation flow down).
  </action>
  <verify>dotnet build src/SharpDicom/SharpDicom.csproj --no-restore</verify>
  <done>DicomDataset has Parent property for sequence item context inheritance</done>
</task>

<task type="auto">
  <name>Task 2: Create SequenceParser class</name>
  <files>src/SharpDicom/IO/SequenceParser.cs</files>
  <action>
Create a new SequenceParser class that handles DICOM sequence parsing:

```csharp
namespace SharpDicom.IO
{
    /// <summary>
    /// Parses DICOM sequences (SQ VR) with nested datasets.
    /// </summary>
    /// <remarks>
    /// Uses an explicit stack instead of recursion to handle deeply nested
    /// sequences without risk of stack overflow.
    /// </remarks>
    public sealed class SequenceParser
    {
        // Implementation
    }
}
```

Key implementation details:

1. **Constructor**: Takes DicomReaderOptions for configuration

2. **ParseSequence method**:
   - Parameters: ReadOnlySpan&lt;byte&gt; buffer, DicomTag tag, uint length, bool explicitVR, bool littleEndian, DicomDataset? parent
   - Returns: DicomSequence
   - Handles both defined length (parse bytes) and undefined length (parse until delimiter)
   - Track current depth and throw if exceeds MaxSequenceDepth

3. **ParseItem method**:
   - Parameters: ReadOnlySpan&lt;byte&gt; buffer, uint length, bool explicitVR, bool littleEndian, DicomDataset parent, int depth
   - Returns: DicomDataset
   - Handles both defined length and undefined length items
   - Sets Parent property on returned dataset
   - For each element, check if it's SQ VR and recursively parse

4. **Delimiter tag handling**:
   - Item tag (FFFE,E000): Start of new item
   - ItemDelimitationItem (FFFE,E00D): End of undefined length item
   - SequenceDelimitationItem (FFFE,E0DD): End of undefined length sequence

5. **Depth tracking**:
   - Increment depth when entering nested sequence
   - Check depth against MaxSequenceDepth before parsing
   - Throw DicomDataException if depth exceeded

6. **Item counting**:
   - Track total items across all sequences
   - Throw if exceeds MaxTotalItems

Use the existing DicomStreamReader for low-level parsing. Create a reader instance for parsing nested content.
  </action>
  <verify>dotnet build src/SharpDicom/SharpDicom.csproj --no-restore</verify>
  <done>SequenceParser class implements sequence parsing with depth guard and delimiter handling</done>
</task>

<task type="auto">
  <name>Task 3: Create sequence parsing tests</name>
  <files>tests/SharpDicom.Tests/IO/SequenceParsingTests.cs</files>
  <action>
Create comprehensive tests for SequenceParser:

1. **Empty sequence tests**:
   - Empty sequence with defined length (0)
   - Empty sequence with undefined length (just delimiters)
   - Verify Items.Count == 0, not null

2. **Single item tests**:
   - Single item with defined length
   - Single item with undefined length
   - Item containing string elements
   - Item containing numeric elements

3. **Multiple item tests**:
   - Two items in sequence
   - Five items in sequence
   - Mixed defined/undefined length items

4. **Nested sequence tests**:
   - Sequence containing sequence (depth 2)
   - Three levels of nesting (depth 3)
   - Five levels of nesting (depth 5 - verify works)

5. **Depth limit tests**:
   - Verify MaxSequenceDepth = 5 throws on depth 6
   - Verify MaxSequenceDepth = 128 accepts depth 100

6. **Delimiter handling tests**:
   - Correct termination on SequenceDelimitationItem
   - Correct termination on ItemDelimitationItem
   - Proper handling of nested delimiters (inner delimiter doesn't end outer)

7. **Parent reference tests**:
   - Verify item has Parent set to correct dataset
   - Verify nested item Parent chain correct

Build test byte arrays manually representing DICOM sequences:
- Sequence format: Tag + VR(SQ) + Length + Items + Delimiter
- Item format: Item tag (FFFE,E000) + Length + Elements + Delimiter
- Use both explicit VR and implicit VR modes

Test with explicit VR first (simpler), then implicit VR.
  </action>
  <verify>dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj --filter "FullyQualifiedName~SequenceParsingTests" --no-restore</verify>
  <done>All sequence parsing tests pass including nested sequences and delimiter handling</done>
</task>

</tasks>

<verification>
Run full test suite to ensure no regressions:

```bash
dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj
```

Expected: All existing tests pass plus new SequenceParsingTests.
</verification>

<success_criteria>
- SequenceParser correctly parses defined length sequences
- SequenceParser correctly parses undefined length sequences (delimiter-based)
- Nested sequences work to depth 5+ without issue
- Depth guard throws at configurable limit
- Empty sequences return empty Items collection
- Parent property correctly set on sequence items
- All sequence parsing tests pass
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-implicit-vr-sequences/03-02-SUMMARY.md`
</output>
