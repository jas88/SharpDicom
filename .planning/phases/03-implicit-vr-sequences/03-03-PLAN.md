---
phase: 03-implicit-vr-sequences
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/SharpDicom/IO/DicomFileReader.cs
  - src/SharpDicom/IO/DicomStreamReader.cs
  - tests/SharpDicom.Tests/IO/DicomFileReaderSequenceTests.cs
autonomous: true

must_haves:
  truths:
    - "DicomFileReader yields sequence elements via IAsyncEnumerable"
    - "DicomFile.Open parses files with sequences"
    - "Implicit VR files with sequences parse correctly"
    - "Streaming mode handles sequences without loading all in memory"
  artifacts:
    - path: "src/SharpDicom/IO/DicomFileReader.cs"
      provides: "Sequence integration in high-level reader"
      contains: "SequenceParser"
    - path: "tests/SharpDicom.Tests/IO/DicomFileReaderSequenceTests.cs"
      provides: "Integration tests for file reader with sequences"
      min_lines: 100
  key_links:
    - from: "DicomFileReader.ParseElementsFromBuffer"
      to: "SequenceParser.ParseSequence"
      via: "sequence element creation"
      pattern: "ParseSequence"
---

<objective>
Integrate sequence parsing into DicomFileReader for complete DICOM file support.

Purpose: DicomFileReader currently skips sequences (Phase 2 limitation). This plan integrates SequenceParser to enable full parsing of DICOM files with sequences via both streaming and complete loading APIs.

Output:
- DicomFileReader creates DicomSequence elements instead of skipping
- Handles both explicit and implicit VR sequences
- Integration tests with real-world-like DICOM byte structures
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-implicit-vr-sequences/03-RESEARCH.md
@.planning/phases/03-implicit-vr-sequences/03-CONTEXT.md
@.planning/phases/03-implicit-vr-sequences/03-01-SUMMARY.md
@.planning/phases/03-implicit-vr-sequences/03-02-SUMMARY.md
@src/SharpDicom/IO/DicomFileReader.cs
@src/SharpDicom/IO/SequenceParser.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate SequenceParser into DicomFileReader</name>
  <files>src/SharpDicom/IO/DicomFileReader.cs</files>
  <action>
Update DicomFileReader to use SequenceParser for sequence elements:

1. **Add SequenceParser field**:
   - Private field _sequenceParser initialized in constructor
   - Pass _options to parser

2. **Update ParseElementsFromBuffer method**:
   - Remove the TODO comment and skip logic for sequences
   - When VR == DicomVR.SQ or valueLength == 0xFFFFFFFF (undefined length):
     - Call SequenceParser.ParseSequence with appropriate parameters
     - Add resulting DicomSequence to elements list
   - For defined length sequences, pass the value span to parser
   - For undefined length sequences, need to find delimiter and pass that span

3. **Handle undefined length in streaming**:
   - Undefined length sequences require scanning for delimiter
   - Buffer may not contain entire sequence
   - For now: if undefined length and not enough data, accumulate buffer until delimiter found
   - Add a method to find SequenceDelimitationItem in buffer

4. **Preserve parent context**:
   - When parsing sequences, pass current dataset (null for top-level) as parent
   - This enables context inheritance for nested VR resolution

5. **Handle implicit VR mode**:
   - SequenceParser needs to know if parsing implicit or explicit VR
   - Pass TransferSyntax.IsExplicitVR to parser

Note: For Phase 3, focus on files that fit in buffer. Full streaming of huge sequences is a later optimization.
  </action>
  <verify>dotnet build src/SharpDicom/SharpDicom.csproj --no-restore</verify>
  <done>DicomFileReader integrates SequenceParser to handle sequence elements</done>
</task>

<task type="auto">
  <name>Task 2: Add sequence detection to DicomStreamReader</name>
  <files>src/SharpDicom/IO/DicomStreamReader.cs</files>
  <action>
Add helper methods to DicomStreamReader for sequence handling:

1. **Add PeekTag method**:
   - Returns DicomTag at current position without advancing
   - Returns null/default if insufficient data
   - Useful for checking if next tag is a delimiter

2. **Add IsDelimiterTag static method**:
   - Returns true if tag.Group == 0xFFFE
   - Covers Item, ItemDelimitationItem, SequenceDelimitationItem

3. **Add FindSequenceDelimiter method**:
   - Scans buffer for SequenceDelimitationItem (FFFE,E0DD)
   - Returns offset of delimiter or -1 if not found
   - Used for undefined length sequence bounds detection

4. **Add SkipValue method**:
   - Skip valueLength bytes without parsing
   - Used when skipping elements in item parsing

These helpers enable SequenceParser and DicomFileReader to work with sequences efficiently.
  </action>
  <verify>dotnet build src/SharpDicom/SharpDicom.csproj --no-restore</verify>
  <done>DicomStreamReader has helper methods for sequence parsing</done>
</task>

<task type="auto">
  <name>Task 3: Create integration tests for sequences in files</name>
  <files>tests/SharpDicom.Tests/IO/DicomFileReaderSequenceTests.cs</files>
  <action>
Create integration tests for DicomFileReader with sequences:

1. **Basic sequence in file**:
   - Create byte array representing complete DICOM file with preamble, FMI, and dataset with sequence
   - Use MemoryStream to test DicomFileReader
   - Verify sequence element is yielded
   - Verify Items count matches expected

2. **Implicit VR file with sequence**:
   - Create implicit VR Little Endian encoded file with sequence
   - Verify VR lookup works for sequence contents
   - Verify sequence parses correctly

3. **Nested sequences in file**:
   - Create file with 2-level nested sequence
   - Verify outer sequence contains inner sequence
   - Verify all items accessible

4. **DicomFile.Open with sequences**:
   - Test DicomFile.Open(stream) with sequence data
   - Verify Dataset contains sequence
   - Verify sequence Items accessible
   - Verify nested items have correct Parent

5. **Empty sequence in file**:
   - File with empty sequence (0 items)
   - Verify sequence exists but Items.Count == 0

6. **Multiple sequences in file**:
   - File with two different sequences
   - Verify both sequences present and distinct

Build realistic byte arrays:
- Preamble (128 zeros) + "DICM"
- FMI with Transfer Syntax UID
- Dataset with sequences

Test both streaming (ReadElementsAsync) and complete loading (ReadDatasetAsync).
  </action>
  <verify>dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj --filter "FullyQualifiedName~DicomFileReaderSequenceTests" --no-restore</verify>
  <done>All DicomFileReader sequence integration tests pass</done>
</task>

</tasks>

<verification>
Run full test suite to ensure no regressions:

```bash
dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj
```

Expected: All existing tests pass plus new DicomFileReaderSequenceTests.
</verification>

<success_criteria>
- DicomFileReader yields DicomSequence elements (not skipping)
- ReadElementsAsync streams sequences correctly
- ReadDatasetAsync includes sequences in dataset
- Both explicit VR and implicit VR sequences work
- Nested sequences correctly parsed in files
- DicomFile.Open handles files with sequences
- All integration tests pass
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-implicit-vr-sequences/03-03-SUMMARY.md`
</output>
