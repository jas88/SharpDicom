---
phase: 03-implicit-vr-sequences
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SharpDicom/IO/DicomReaderOptions.cs
  - src/SharpDicom/IO/DicomStreamReader.cs
  - src/SharpDicom/Data/DicomDataset.cs
  - tests/SharpDicom.Tests/IO/ImplicitVRParsingTests.cs
autonomous: true

must_haves:
  truths:
    - "Implicit VR elements use dictionary lookup for VR"
    - "Unknown tags in implicit VR default to UN"
    - "Implicit VR always uses 32-bit length field"
    - "MaxSequenceDepth configurable in DicomReaderOptions"
  artifacts:
    - path: "src/SharpDicom/IO/DicomReaderOptions.cs"
      provides: "MaxSequenceDepth and MaxTotalItems configuration"
      contains: "MaxSequenceDepth"
    - path: "src/SharpDicom/IO/DicomStreamReader.cs"
      provides: "Implicit VR parsing with dictionary lookup"
      contains: "DicomDictionary.Default.GetEntry"
    - path: "tests/SharpDicom.Tests/IO/ImplicitVRParsingTests.cs"
      provides: "Unit tests for implicit VR parsing"
      min_lines: 80
  key_links:
    - from: "DicomStreamReader.TryReadElementHeader"
      to: "DicomDictionary.Default.GetEntry"
      via: "VR lookup when _explicitVR is false"
      pattern: "GetEntry.*tag"
---

<objective>
Extend DicomReaderOptions with sequence-related configuration and verify implicit VR parsing in DicomStreamReader.

Purpose: Implicit VR Little Endian is the default DICOM transfer syntax. The DicomStreamReader already has basic implicit VR support (from Phase 2) but needs verification and the options need sequence depth configuration for Phase 3.

Output:
- Extended DicomReaderOptions with MaxSequenceDepth, MaxTotalItems
- Verified implicit VR parsing with dictionary lookup
- Unit tests for implicit VR element parsing
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-implicit-vr-sequences/03-RESEARCH.md
@.planning/phases/03-implicit-vr-sequences/03-CONTEXT.md
@src/SharpDicom/IO/DicomReaderOptions.cs
@src/SharpDicom/IO/DicomStreamReader.cs
@src/SharpDicom/Data/DicomDictionary.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend DicomReaderOptions with sequence configuration</name>
  <files>src/SharpDicom/IO/DicomReaderOptions.cs</files>
  <action>
Add sequence-related configuration to DicomReaderOptions:

1. Add MaxSequenceDepth property (int, default 128 per CONTEXT.md decision)
2. Add MaxTotalItems property (int, default 100,000 per CONTEXT.md decision)
3. Update the Strict/Lenient/Permissive presets appropriately:
   - Strict: MaxSequenceDepth = 128, MaxTotalItems = 100,000
   - Lenient: MaxSequenceDepth = 128, MaxTotalItems = 100,000
   - Permissive: MaxSequenceDepth = 256, MaxTotalItems = 500,000

Add XML documentation for each new property explaining their purpose.
  </action>
  <verify>dotnet build src/SharpDicom/SharpDicom.csproj --no-restore</verify>
  <done>DicomReaderOptions has MaxSequenceDepth and MaxTotalItems properties with appropriate defaults</done>
</task>

<task type="auto">
  <name>Task 2: Create implicit VR parsing tests</name>
  <files>tests/SharpDicom.Tests/IO/ImplicitVRParsingTests.cs</files>
  <action>
Create comprehensive unit tests for implicit VR parsing in DicomStreamReader:

1. Test that implicit VR parses tag correctly (group, element)
2. Test that implicit VR looks up VR from dictionary (e.g., PatientName -> PN)
3. Test that unknown tags default to UN VR
4. Test that implicit VR uses 32-bit length field
5. Test that private tags (odd group) default to UN
6. Test multiple elements in sequence
7. Test edge cases: empty value, maximum length value

Use hand-crafted byte arrays representing implicit VR encoded elements:
- Implicit VR format: 4 bytes tag (group LE, element LE) + 4 bytes length (LE) + value bytes
- Use DicomTag.PatientName (0010,0010) which has VR=PN in dictionary
- Use DicomTag.SOPClassUID (0008,0016) which has VR=UI in dictionary

Verify DicomStreamReader correctly determines VR from dictionary lookup.
  </action>
  <verify>dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj --filter "FullyQualifiedName~ImplicitVRParsingTests" --no-restore</verify>
  <done>All implicit VR parsing tests pass, verifying dictionary lookup works correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add context value caching to DicomDataset</name>
  <files>src/SharpDicom/Data/DicomDataset.cs</files>
  <action>
Per CONTEXT.md decision, add cached context values for VR resolution:

1. Add private backing fields for context values:
   - _bitsAllocated (ushort?)
   - _pixelRepresentation (ushort?)

2. Add public read-only properties:
   - BitsAllocated (ushort?) - cached value of (0028,0100)
   - PixelRepresentation (ushort?) - cached value of (0028,0103)

3. Update the Add method to detect and cache these context tags:
   - When tag == DicomTag.BitsAllocated, parse and cache value
   - When tag == DicomTag.PixelRepresentation, parse and cache value

4. Add well-known tag constants to DicomTag.WellKnown.cs if not present:
   - DicomTag.BitsAllocated (0028,0100)
   - DicomTag.PixelRepresentation (0028,0103)

5. Ensure ToOwned() copies cached context values.

This enables efficient VR resolution for multi-VR tags like Pixel Data without re-parsing.
  </action>
  <verify>dotnet build src/SharpDicom/SharpDicom.csproj --no-restore</verify>
  <done>DicomDataset caches BitsAllocated and PixelRepresentation for context-dependent VR resolution</done>
</task>

</tasks>

<verification>
Run full test suite to ensure no regressions:

```bash
dotnet test tests/SharpDicom.Tests/SharpDicom.Tests.csproj
```

Expected: All existing tests pass plus new ImplicitVRParsingTests.
</verification>

<success_criteria>
- DicomReaderOptions has MaxSequenceDepth = 128 (default) and MaxTotalItems = 100,000 (default)
- DicomStreamReader correctly parses implicit VR elements using dictionary lookup
- Unknown tags in implicit VR mode get VR = UN
- All implicit VR parsing tests pass
- DicomDataset caches BitsAllocated and PixelRepresentation
- All existing tests continue to pass (300+ tests)
</success_criteria>

<output>
After completion, create `.planning/phases/03-implicit-vr-sequences/03-01-SUMMARY.md`
</output>
