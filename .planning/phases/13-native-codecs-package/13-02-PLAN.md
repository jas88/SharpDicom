---
phase: 13-native-codecs-package
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - native/vendor/README.md
  - native/src/jpeg_wrapper.h
  - native/src/jpeg_wrapper.c
  - native/src/sharpdicom_codecs.c
  - native/build.zig
autonomous: true

must_haves:
  truths:
    - "JPEG decode produces correct pixel data from compressed input"
    - "JPEG encode produces valid JPEG from raw pixels"
    - "8-bit, 12-bit color depths are supported"
  artifacts:
    - path: "native/src/jpeg_wrapper.c"
      provides: "libjpeg-turbo wrapper implementation"
      exports: ["jpeg_decode", "jpeg_encode", "jpeg_free"]
      min_lines: 150
    - path: "native/src/jpeg_wrapper.h"
      provides: "JPEG wrapper API declarations"
      min_lines: 30
  key_links:
    - from: "native/src/sharpdicom_codecs.c"
      to: "native/src/jpeg_wrapper.c"
      via: "include and feature flag"
      pattern: "SHARPDICOM_HAS_JPEG"
---

<objective>
Implement libjpeg-turbo wrapper for JPEG baseline and extended codecs

Purpose: Provide high-performance JPEG encoding/decoding that wraps libjpeg-turbo's TurboJPEG API, handling DICOM-specific requirements like 12-bit support and YBR colorspace.

Output: JPEG wrapper functions callable from managed code via P/Invoke
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-native-codecs-package/13-CONTEXT.md
@.planning/phases/13-native-codecs-package/13-RESEARCH.md
@.planning/phases/13-native-codecs-package/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create libjpeg-turbo vendoring setup</name>
  <files>
    native/vendor/README.md
    native/vendor/libjpeg-turbo/.gitkeep
  </files>
  <action>
Set up the vendor directory structure for libjpeg-turbo:

1. Create `native/vendor/README.md`:
   - Document vendored dependencies and their versions
   - libjpeg-turbo: version 3.0.x, source from https://github.com/libjpeg-turbo/libjpeg-turbo
   - Explain that sources are not committed to repo (downloaded by CI)
   - Document build-time requirements
   - License: IJG/BSD-3-Clause/zlib

2. Create `native/vendor/libjpeg-turbo/.gitkeep`:
   - Placeholder for CI to download sources

3. Update `.github/workflows/native-build.yml` to add step:
   ```yaml
   - name: Download libjpeg-turbo
     run: |
       curl -L https://github.com/libjpeg-turbo/libjpeg-turbo/archive/refs/tags/3.0.4.tar.gz | tar xz
       mv libjpeg-turbo-3.0.4 native/vendor/libjpeg-turbo
   ```

Note: For local development, the wrapper can be compiled against system libjpeg-turbo headers. The vendored source is for CI reproducibility.
  </action>
  <verify>
```bash
cat /Users/jas88/Developer/Github/SharpDicom/native/vendor/README.md
ls /Users/jas88/Developer/Github/SharpDicom/native/vendor/libjpeg-turbo/
```
README documents dependencies, directory structure exists
  </verify>
  <done>
Vendor directory structure established, CI downloads libjpeg-turbo source for builds
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement JPEG wrapper</name>
  <files>
    native/src/jpeg_wrapper.h
    native/src/jpeg_wrapper.c
    native/src/sharpdicom_codecs.c
    native/build.zig
  </files>
  <action>
1. Create `native/src/jpeg_wrapper.h`:
   - Include guard and extern "C" for C++ compatibility
   - Colorspace enum: JPEG_CS_RGB = 0, JPEG_CS_YBR = 1, JPEG_CS_GRAY = 2
   - Subsampling enum: JPEG_SAMP_444 = 0, JPEG_SAMP_422 = 1, JPEG_SAMP_420 = 2
   - Function declarations:
     ```c
     int jpeg_decode(
         const uint8_t* input, int inputLen,
         uint8_t* output, int outputLen,
         int* width, int* height, int* components,
         int colorspace);

     int jpeg_encode(
         const uint8_t* input, int width, int height, int components,
         uint8_t** output, int* outputLen,
         int quality, int subsamp);

     void jpeg_free(uint8_t* buffer);

     // 12-bit support (DICOM extended JPEG)
     int jpeg_decode_12bit(
         const uint8_t* input, int inputLen,
         uint16_t* output, int outputLen,
         int* width, int* height, int* components);

     int jpeg_encode_12bit(
         const uint16_t* input, int width, int height, int components,
         uint8_t** output, int* outputLen,
         int quality);
     ```

2. Create `native/src/jpeg_wrapper.c`:
   - Include turbojpeg.h (or define minimal subset if header not available)
   - Thread-local tjhandle for decompression/compression (lazy init)
   - jpeg_decode():
     - Create/reuse tjhandle via tjInitDecompress()
     - Call tjDecompressHeader3() to get dimensions
     - Validate output buffer size
     - Call tjDecompress2() with appropriate pixel format
     - Handle TJFLAG_FASTUPSAMPLE for speed
     - On error: set_error(tjGetErrorStr2(handle)), return error code
   - jpeg_encode():
     - Create/reuse tjhandle via tjInitCompress()
     - Allocate output buffer via tjAlloc()
     - Call tjCompress2() with quality and subsampling
     - On error: set_error(tjGetErrorStr2(handle)), return error code
   - jpeg_free():
     - Call tjFree() on buffer
   - For 12-bit: Use TJPF_GRAY16/TJCS_GRAY with 12-bit compile flag
     (Note: Full 12-bit requires libjpeg-turbo built with -DWITH_12BIT=1)

3. Update `native/src/sharpdicom_codecs.c`:
   - Include jpeg_wrapper.h
   - Update sharpdicom_features() to set SHARPDICOM_HAS_JPEG bit

4. Update `native/build.zig`:
   - Add jpeg_wrapper.c to source files
   - Link against libjpeg-turbo (libturbojpeg static library)
   - Add include path for turbojpeg.h
  </action>
  <verify>
```bash
# Check files exist and have expected functions
grep -l "jpeg_decode" /Users/jas88/Developer/Github/SharpDicom/native/src/jpeg_wrapper.c
grep "SHARPDICOM_HAS_JPEG" /Users/jas88/Developer/Github/SharpDicom/native/src/sharpdicom_codecs.c
```
JPEG wrapper implements decode/encode, sharpdicom_codecs sets JPEG feature flag
  </verify>
  <done>
JPEG wrapper provides decode/encode for 8-bit and 12-bit, integrates with main wrapper, build system updated to include libjpeg-turbo
  </done>
</task>

</tasks>

<verification>
- [ ] native/vendor/README.md documents libjpeg-turbo dependency
- [ ] native/src/jpeg_wrapper.h declares all JPEG functions
- [ ] native/src/jpeg_wrapper.c implements TurboJPEG API usage
- [ ] 8-bit and 12-bit decode paths are implemented
- [ ] encode with quality and subsampling options works
- [ ] Error messages propagate via set_error()
- [ ] sharpdicom_features() reports JPEG capability
- [ ] build.zig includes jpeg_wrapper.c and links libjpeg-turbo
</verification>

<success_criteria>
- JPEG wrapper compiles with libjpeg-turbo headers
- Decode function handles JPEG input and produces raw pixel output
- Encode function produces valid JPEG from raw pixels
- 12-bit extended JPEG support is stubbed (full impl depends on library build flags)
- Error handling follows established pattern with thread-local messages
</success_criteria>

<output>
After completion, create `.planning/phases/13-native-codecs-package/13-02-SUMMARY.md`
</output>
