---
phase: 13-native-codecs-package
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - native/vendor/openjpeg/.gitkeep
  - native/src/j2k_wrapper.h
  - native/src/j2k_wrapper.c
  - native/src/sharpdicom_codecs.c
  - native/build.zig
autonomous: true

must_haves:
  truths:
    - "JPEG 2000 decode produces correct pixel data from J2K codestream"
    - "JPEG 2000 encode produces valid J2K from raw pixels"
    - "Resolution level decode enables thumbnail generation"
    - "ROI decode works for large images"
  artifacts:
    - path: "native/src/j2k_wrapper.c"
      provides: "OpenJPEG wrapper implementation"
      exports: ["j2k_decode", "j2k_encode", "j2k_free"]
      min_lines: 200
    - path: "native/src/j2k_wrapper.h"
      provides: "JPEG 2000 wrapper API declarations"
      min_lines: 40
  key_links:
    - from: "native/src/sharpdicom_codecs.c"
      to: "native/src/j2k_wrapper.c"
      via: "include and feature flag"
      pattern: "SHARPDICOM_HAS_J2K"
---

<objective>
Implement OpenJPEG wrapper for JPEG 2000 lossless and lossy codecs

Purpose: Provide JPEG 2000 encoding/decoding using OpenJPEG library, supporting resolution levels for thumbnails, ROI decode for large images, and both lossless and lossy compression.

Output: JPEG 2000 wrapper functions with advanced features (resolution levels, ROI, tiled encode)
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-native-codecs-package/13-CONTEXT.md
@.planning/phases/13-native-codecs-package/13-RESEARCH.md
@.planning/phases/13-native-codecs-package/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up OpenJPEG vendoring</name>
  <files>
    native/vendor/openjpeg/.gitkeep
    native/vendor/README.md
  </files>
  <action>
1. Create `native/vendor/openjpeg/.gitkeep` placeholder

2. Update `native/vendor/README.md` to add OpenJPEG:
   - OpenJPEG: version 2.5.x, source from https://github.com/uclouvain/openjpeg
   - License: BSD-2-Clause
   - Note HTJ2K support available in OpenJPEG 2.5+

3. Update `.github/workflows/native-build.yml` to add download step:
   ```yaml
   - name: Download OpenJPEG
     run: |
       curl -L https://github.com/uclouvain/openjpeg/archive/refs/tags/v2.5.3.tar.gz | tar xz
       mv openjpeg-2.5.3 native/vendor/openjpeg
   ```
  </action>
  <verify>
```bash
ls /Users/jas88/Developer/Github/SharpDicom/native/vendor/openjpeg/
grep -i openjpeg /Users/jas88/Developer/Github/SharpDicom/native/vendor/README.md
```
Directory exists, README documents OpenJPEG
  </verify>
  <done>
OpenJPEG vendoring structure established
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement JPEG 2000 wrapper</name>
  <files>
    native/src/j2k_wrapper.h
    native/src/j2k_wrapper.c
    native/src/sharpdicom_codecs.c
    native/build.zig
  </files>
  <action>
1. Create `native/src/j2k_wrapper.h`:
   - Include guard and extern "C"
   - Codec format enum: J2K_FORMAT_J2K = 0, J2K_FORMAT_JP2 = 1
   - Function declarations:
     ```c
     // Basic decode - full resolution
     int j2k_decode(
         const uint8_t* input, int inputLen,
         uint8_t* output, int outputLen,
         int* width, int* height, int* components, int* bitsPerSample,
         int resolutionLevel);  // 0=full, 1=half, 2=quarter...

     // ROI decode - decode only specified region
     int j2k_decode_region(
         const uint8_t* input, int inputLen,
         uint8_t* output, int outputLen,
         int startX, int startY, int endX, int endY,
         int* components, int* bitsPerSample);

     // Encode
     int j2k_encode(
         const uint8_t* input, int width, int height, int components, int bitsPerSample,
         uint8_t** output, int* outputLen,
         int lossless, float compressionRatio, int tileSize);

     // Query codestream info without full decode
     int j2k_get_info(
         const uint8_t* input, int inputLen,
         int* width, int* height, int* components, int* bitsPerSample,
         int* numResolutions, int* numTiles);

     void j2k_free(uint8_t* buffer);
     ```

2. Create `native/src/j2k_wrapper.c`:
   - Include openjpeg.h
   - Memory stream callbacks for opj_stream:
     - Custom read/seek/skip functions that read from byte buffer
   - Error/warning/info message handlers:
     - error_callback: call set_error() with message
     - warning_callback: ignore or log
     - info_callback: ignore
   - j2k_decode():
     - Detect format (J2K vs JP2) from magic bytes
     - Create codec via opj_create_decompress(format)
     - Set up stream with memory callbacks
     - opj_read_header() to get image info
     - If resolutionLevel > 0: opj_set_decoded_resolution_factor()
     - opj_decode() to decode image
     - Copy image data to output buffer (handle component interleaving)
     - opj_image_destroy(), opj_destroy_codec(), opj_stream_destroy()
   - j2k_decode_region():
     - Same as j2k_decode but call opj_set_decode_area() before decode
   - j2k_encode():
     - Create codec via opj_create_compress(OPJ_CODEC_J2K)
     - Set encoding parameters:
       - If lossless: irreversible = 0, tcp_rates[0] = 0
       - If lossy: irreversible = 1, tcp_rates[0] = compressionRatio
       - tile_size_on = (tileSize > 0), cp_tx0/cp_ty0/cp_tdx/cp_tdy
     - Create opj_image with components
     - opj_encode() and opj_end_compress()
     - Return compressed data
   - j2k_get_info():
     - Partial decode - just read header, no pixel decode

3. Update `native/src/sharpdicom_codecs.c`:
   - Include j2k_wrapper.h
   - Update sharpdicom_features() to set SHARPDICOM_HAS_J2K bit

4. Update `native/build.zig`:
   - Add j2k_wrapper.c to source files
   - Link against OpenJPEG static library
   - Add include path for openjpeg.h
  </action>
  <verify>
```bash
grep -l "j2k_decode" /Users/jas88/Developer/Github/SharpDicom/native/src/j2k_wrapper.c
grep "SHARPDICOM_HAS_J2K" /Users/jas88/Developer/Github/SharpDicom/native/src/sharpdicom_codecs.c
grep "j2k_wrapper" /Users/jas88/Developer/Github/SharpDicom/native/build.zig
```
J2K wrapper implements functions, feature flag set, build includes j2k_wrapper
  </verify>
  <done>
JPEG 2000 wrapper provides full decode, resolution level decode, ROI decode, and encode with lossless/lossy options
  </done>
</task>

</tasks>

<verification>
- [ ] native/vendor/openjpeg/.gitkeep exists
- [ ] native/vendor/README.md documents OpenJPEG 2.5.x dependency
- [ ] native/src/j2k_wrapper.h declares all J2K functions
- [ ] native/src/j2k_wrapper.c implements OpenJPEG API usage
- [ ] Resolution level decode (thumbnail) works
- [ ] ROI decode (partial image) works
- [ ] Lossless and lossy encode work
- [ ] sharpdicom_features() reports J2K capability
- [ ] build.zig includes j2k_wrapper.c and links OpenJPEG
</verification>

<success_criteria>
- JPEG 2000 wrapper compiles with OpenJPEG headers
- Decode handles J2K and JP2 formats
- Resolution levels enable fast thumbnail generation
- ROI decode enables efficient large image handling
- Encode supports both lossless and lossy modes
- Error handling follows established pattern
</success_criteria>

<output>
After completion, create `.planning/phases/13-native-codecs-package/13-03-SUMMARY.md`
</output>
