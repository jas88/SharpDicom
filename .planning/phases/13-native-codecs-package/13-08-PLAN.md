---
phase: 13-native-codecs-package
plan: 08
type: execute
wave: 5
depends_on: ["13-07"]
files_modified:
  - src/SharpDicom.Codecs/SharpDicom.Codecs.nuspec
  - src/SharpDicom.Codecs/build/SharpDicom.Codecs.targets
  - nuget/SharpDicom.Codecs.runtime.win-x64.nuspec
  - nuget/SharpDicom.Codecs.runtime.linux-x64.nuspec
  - nuget/SharpDicom.Codecs.runtime.osx-arm64.nuspec
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "NuGet packages install correctly and load native libraries"
    - "Runtime packages contain correct native binaries for each platform"
    - "Self-contained publish includes native libraries"
  artifacts:
    - path: "src/SharpDicom.Codecs/SharpDicom.Codecs.nuspec"
      provides: "Meta package specification"
      min_lines: 40
    - path: "src/SharpDicom.Codecs/build/SharpDicom.Codecs.targets"
      provides: "MSBuild targets for native library copying"
      min_lines: 15
  key_links:
    - from: "src/SharpDicom.Codecs/SharpDicom.Codecs.nuspec"
      to: "nuget/SharpDicom.Codecs.runtime.*.nuspec"
      via: "dependency on runtime packages"
      pattern: "SharpDicom\\.Codecs\\.runtime"
---

<objective>
Create NuGet package structure for cross-platform distribution

Purpose: Set up the meta package (SharpDicom.Codecs) and runtime packages (SharpDicom.Codecs.runtime.{RID}) following NuGet native package conventions.

Output: NuGet package specifications, MSBuild targets, and release workflow
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-native-codecs-package/13-CONTEXT.md
@.planning/phases/13-native-codecs-package/13-RESEARCH.md
@.planning/phases/13-native-codecs-package/13-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create meta package and MSBuild targets</name>
  <files>
    src/SharpDicom.Codecs/build/SharpDicom.Codecs.targets
    src/SharpDicom.Codecs/buildTransitive/SharpDicom.Codecs.targets
    src/SharpDicom.Codecs/SharpDicom.Codecs.csproj
  </files>
  <action>
1. Create `src/SharpDicom.Codecs/build/SharpDicom.Codecs.targets`:
   ```xml
   <Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
     <!--
       This file ensures native libraries are copied to the output directory.
       Runtime packages place natives in runtimes/{RID}/native/.
       NuGet automatically handles this for publish, but we need it for build too.
     -->

     <PropertyGroup>
       <_SharpDicomCodecsNativeDir>$(MSBuildThisFileDirectory)..\runtimes\$(RuntimeIdentifier)\native\</_SharpDicomCodecsNativeDir>
     </PropertyGroup>

     <!-- Copy natives to output for development builds -->
     <ItemGroup Condition="Exists('$(_SharpDicomCodecsNativeDir)')">
       <None Include="$(_SharpDicomCodecsNativeDir)*"
             CopyToOutputDirectory="PreserveNewest"
             Link="%(Filename)%(Extension)"
             Visible="false" />
     </ItemGroup>

     <!-- Warn if runtime package not installed -->
     <Target Name="_SharpDicomCodecsCheckRuntime"
             BeforeTargets="Build"
             Condition="'$(RuntimeIdentifier)' != '' AND !Exists('$(_SharpDicomCodecsNativeDir)')">
       <Warning Text="SharpDicom.Codecs native libraries not found for $(RuntimeIdentifier). Install SharpDicom.Codecs.runtime.$(RuntimeIdentifier)." />
     </Target>
   </Project>
   ```

2. Create `src/SharpDicom.Codecs/buildTransitive/SharpDicom.Codecs.targets`:
   - Same content as build/SharpDicom.Codecs.targets
   - buildTransitive applies to projects that transitively reference this package

3. Update `src/SharpDicom.Codecs/SharpDicom.Codecs.csproj` to include targets:
   ```xml
   <ItemGroup>
     <None Include="build\**\*" Pack="true" PackagePath="build" />
     <None Include="buildTransitive\**\*" Pack="true" PackagePath="buildTransitive" />
   </ItemGroup>

   <!-- Conditional runtime package references based on RID -->
   <ItemGroup Condition="'$(RuntimeIdentifier)' == 'win-x64'">
     <PackageReference Include="SharpDicom.Codecs.runtime.win-x64" Version="$(PackageVersion)" PrivateAssets="none" />
   </ItemGroup>
   <ItemGroup Condition="'$(RuntimeIdentifier)' == 'win-arm64'">
     <PackageReference Include="SharpDicom.Codecs.runtime.win-arm64" Version="$(PackageVersion)" PrivateAssets="none" />
   </ItemGroup>
   <ItemGroup Condition="'$(RuntimeIdentifier)' == 'linux-x64'">
     <PackageReference Include="SharpDicom.Codecs.runtime.linux-x64" Version="$(PackageVersion)" PrivateAssets="none" />
   </ItemGroup>
   <ItemGroup Condition="'$(RuntimeIdentifier)' == 'linux-arm64'">
     <PackageReference Include="SharpDicom.Codecs.runtime.linux-arm64" Version="$(PackageVersion)" PrivateAssets="none" />
   </ItemGroup>
   <ItemGroup Condition="'$(RuntimeIdentifier)' == 'osx-x64'">
     <PackageReference Include="SharpDicom.Codecs.runtime.osx-x64" Version="$(PackageVersion)" PrivateAssets="none" />
   </ItemGroup>
   <ItemGroup Condition="'$(RuntimeIdentifier)' == 'osx-arm64'">
     <PackageReference Include="SharpDicom.Codecs.runtime.osx-arm64" Version="$(PackageVersion)" PrivateAssets="none" />
   </ItemGroup>
   ```
  </action>
  <verify>
```bash
cat /Users/jas88/Developer/Github/SharpDicom/src/SharpDicom.Codecs/build/SharpDicom.Codecs.targets
```
MSBuild targets file exists with native library handling
  </verify>
  <done>
Meta package targets ensure native libraries are copied to output directory
  </done>
</task>

<task type="auto">
  <name>Task 2: Create runtime package specifications and release workflow</name>
  <files>
    nuget/SharpDicom.Codecs.runtime.win-x64.nuspec
    nuget/SharpDicom.Codecs.runtime.linux-x64.nuspec
    nuget/SharpDicom.Codecs.runtime.osx-arm64.nuspec
    .github/workflows/release.yml
  </files>
  <action>
1. Create `nuget/SharpDicom.Codecs.runtime.win-x64.nuspec`:
   ```xml
   <?xml version="1.0" encoding="utf-8"?>
   <package xmlns="http://schemas.microsoft.com/packaging/2013/05/nuspec.xsd">
     <metadata>
       <id>SharpDicom.Codecs.runtime.win-x64</id>
       <version>$version$</version>
       <authors>SharpDicom Contributors</authors>
       <license type="expression">GPL-3.0-or-later</license>
       <projectUrl>https://github.com/jas88/SharpDicom</projectUrl>
       <description>Native codec libraries for SharpDicom.Codecs (Windows x64)</description>
       <copyright>Copyright SharpDicom Contributors</copyright>
       <tags>DICOM medical imaging native codec jpeg jpeg2000</tags>
       <repository type="git" url="https://github.com/jas88/SharpDicom" />
       <readme>README.md</readme>
     </metadata>
     <files>
       <file src="README.md" target="" />
       <file src="runtimes/win-x64/native/sharpdicom_codecs.dll" target="runtimes/win-x64/native/" />
       <file src="THIRD_PARTY_LICENSES.txt" target="" />
     </files>
   </package>
   ```

2. Create `nuget/SharpDicom.Codecs.runtime.linux-x64.nuspec`:
   - Same structure as win-x64 but with linux-x64 RID
   - Native file: libsharpdicom_codecs.so

3. Create `nuget/SharpDicom.Codecs.runtime.osx-arm64.nuspec`:
   - Same structure with osx-arm64 RID
   - Native file: libsharpdicom_codecs.dylib

4. Create similar nuspecs for: win-arm64, linux-arm64, osx-x64

5. Create `nuget/README.md`:
   ```markdown
   # SharpDicom.Codecs Runtime Package

   This package contains native codec libraries for SharpDicom.Codecs.

   **Do not reference directly.** This package is automatically referenced
   by SharpDicom.Codecs based on your target platform.

   ## Bundled Libraries

   - libjpeg-turbo (JPEG Baseline, Extended)
   - OpenJPEG (JPEG 2000)
   - CharLS (JPEG-LS)
   - FFmpeg subset (MPEG2, MPEG4, HEVC)

   ## License

   This package is licensed under GPL-3.0-or-later.
   See THIRD_PARTY_LICENSES.txt for bundled library licenses.
   ```

6. Create `nuget/THIRD_PARTY_LICENSES.txt`:
   - Include license text for libjpeg-turbo (IJG/BSD-3/zlib)
   - Include license text for OpenJPEG (BSD-2-Clause)
   - Include license text for CharLS (BSD-3-Clause)
   - Include license text for FFmpeg (LGPL-2.1+/GPL-2.0+)

7. Update `.github/workflows/release.yml`:
   ```yaml
   name: Release

   on:
     push:
       tags:
         - 'v*.*.*'

   jobs:
     build-native:
       uses: ./.github/workflows/native-build.yml

     build-managed:
       runs-on: ubuntu-latest
       needs: build-native
       steps:
         - uses: actions/checkout@v4

         - uses: actions/setup-dotnet@v4
           with:
             dotnet-version: '9.0.x'

         - uses: actions/download-artifact@v4
           with:
             name: native-libs
             path: native-artifacts/

         - name: Create runtime packages
           run: |
             VERSION=${GITHUB_REF#refs/tags/v}
             for rid in win-x64 win-arm64 linux-x64 linux-arm64 osx-x64 osx-arm64; do
               mkdir -p nuget/runtimes/$rid/native/
               cp native-artifacts/$rid/* nuget/runtimes/$rid/native/ || true
               nuget pack nuget/SharpDicom.Codecs.runtime.$rid.nuspec -Version $VERSION
             done

         - name: Build meta package
           run: |
             VERSION=${GITHUB_REF#refs/tags/v}
             dotnet pack src/SharpDicom.Codecs/SharpDicom.Codecs.csproj -c Release -p:PackageVersion=$VERSION

         - name: Publish to NuGet
           env:
             NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
           run: |
             dotnet nuget push **/*.nupkg --api-key $NUGET_API_KEY --source https://api.nuget.org/v3/index.json

         - name: Create GitHub Release
           uses: softprops/action-gh-release@v1
           with:
             files: |
               **/*.nupkg
             generate_release_notes: true
   ```
  </action>
  <verify>
```bash
ls /Users/jas88/Developer/Github/SharpDicom/nuget/*.nuspec
grep "runtime.win-x64" /Users/jas88/Developer/Github/SharpDicom/.github/workflows/release.yml
```
Nuspec files exist, release workflow handles all runtime packages
  </verify>
  <done>
Runtime packages for all 6 platforms specified, release workflow publishes to NuGet
  </done>
</task>

</tasks>

<verification>
- [ ] build/SharpDicom.Codecs.targets copies natives to output
- [ ] buildTransitive/SharpDicom.Codecs.targets applies transitively
- [ ] Runtime nuspecs exist for all 6 platforms
- [ ] Each runtime nuspec includes correct native library path
- [ ] nuget/README.md documents bundled libraries
- [ ] THIRD_PARTY_LICENSES.txt includes all licenses
- [ ] release.yml builds native and managed packages
- [ ] release.yml publishes all packages to NuGet
- [ ] GitHub Release is created with artifacts
</verification>

<success_criteria>
- NuGet package structure follows standard conventions
- Runtime packages auto-selected based on RID
- Native libraries copied to output directory on build
- Self-contained publish includes correct natives
- Release workflow automates package creation and publishing
- Third-party license attribution is complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-native-codecs-package/13-08-SUMMARY.md`
</output>
