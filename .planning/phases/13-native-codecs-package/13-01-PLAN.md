---
phase: 13-native-codecs-package
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - native/build.zig
  - native/src/sharpdicom_codecs.h
  - native/src/sharpdicom_codecs.c
  - native/test/test_version.c
  - .github/workflows/native-build.yml
autonomous: true

must_haves:
  truths:
    - "Native build system produces shared libraries for 6 platforms"
    - "Version and feature detection functions are callable"
    - "Error message retrieval works from managed code"
  artifacts:
    - path: "native/build.zig"
      provides: "Zig build configuration for cross-compilation"
      min_lines: 80
    - path: "native/src/sharpdicom_codecs.h"
      provides: "C API header with version, features, error functions"
      exports: ["sharpdicom_version", "sharpdicom_features", "sharpdicom_last_error"]
    - path: "native/src/sharpdicom_codecs.c"
      provides: "Core wrapper implementation"
      min_lines: 50
    - path: ".github/workflows/native-build.yml"
      provides: "CI workflow for native builds"
      min_lines: 40
  key_links:
    - from: "native/build.zig"
      to: "native/src/sharpdicom_codecs.c"
      via: "addCSourceFile"
      pattern: "addCSourceFile.*sharpdicom_codecs"
---

<objective>
Create native build infrastructure using Zig for cross-platform compilation

Purpose: Establish the foundation for building native codec wrappers that can be compiled for all 6 target platforms (win-x64, win-arm64, linux-x64, linux-arm64, osx-x64, osx-arm64) from a single build system.

Output: Working Zig build script, C API header with version/feature detection, and GitHub Actions workflow
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-native-codecs-package/13-CONTEXT.md
@.planning/phases/13-native-codecs-package/13-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zig build system and C API header</name>
  <files>
    native/build.zig
    native/src/sharpdicom_codecs.h
    native/src/sharpdicom_codecs.c
  </files>
  <action>
Create the native build infrastructure:

1. Create `native/build.zig`:
   - Define target matrix for 6 platforms using std.Target.Query
   - Configure shared library output with name "sharpdicom_codecs"
   - Set optimization to ReleaseFast for production builds
   - Add C source files from src/ directory
   - Enable PIC/PIE for ASLR
   - Add -fstack-protector-strong for hardening
   - Export library headers

2. Create `native/src/sharpdicom_codecs.h`:
   - Version constant (SHARPDICOM_NATIVE_VERSION = 1)
   - Feature bitmap constants (SHARPDICOM_HAS_JPEG, SHARPDICOM_HAS_J2K, etc.)
   - SIMD feature bitmap constants (SHARPDICOM_SIMD_SSE2, SHARPDICOM_SIMD_AVX2, SHARPDICOM_SIMD_NEON)
   - Error code constants (-1 to -8)
   - EXPORT macro for platform-specific dllexport/visibility
   - Function declarations:
     - int sharpdicom_version(void)
     - int sharpdicom_features(void)
     - int sharpdicom_simd_features(void)
     - const char* sharpdicom_last_error(void)

3. Create `native/src/sharpdicom_codecs.c`:
   - Thread-local error message buffer (256 bytes)
   - set_error() internal function
   - sharpdicom_version() returning SHARPDICOM_NATIVE_VERSION
   - sharpdicom_features() returning bitmap of available codecs (initially 0)
   - sharpdicom_simd_features() detecting CPU capabilities at runtime
   - sharpdicom_last_error() returning thread-local error string

For SIMD detection, use compiler intrinsics:
- x86_64: Check __builtin_cpu_supports("sse2"), __builtin_cpu_supports("avx2")
- aarch64: NEON always available on 64-bit ARM
  </action>
  <verify>
```bash
cd /Users/jas88/Developer/Github/SharpDicom/native
ls -la build.zig src/sharpdicom_codecs.h src/sharpdicom_codecs.c
```
Files exist with expected content
  </verify>
  <done>
Zig build script configures 6 platform targets, C header defines complete API contract, implementation provides version and SIMD detection
  </done>
</task>

<task type="auto">
  <name>Task 2: Create native test executable and CI workflow</name>
  <files>
    native/test/test_version.c
    .github/workflows/native-build.yml
  </files>
  <action>
1. Create `native/test/test_version.c`:
   - Simple C program that tests the native library
   - Call sharpdicom_version() and verify it returns expected value
   - Call sharpdicom_features() and print available features
   - Call sharpdicom_simd_features() and print detected SIMD
   - Return 0 on success, 1 on failure

2. Update `native/build.zig` to add test executable:
   - Add executable target "test_version" for native platform only
   - Link against sharpdicom_codecs library

3. Create `.github/workflows/native-build.yml`:
   - Trigger on push/pull_request to native/** and .github/workflows/native-build.yml
   - Job 1: build-linux (ubuntu-latest)
     - Install Zig using goto-bus-stop/setup-zig@v2 (version 0.13.0)
     - Build all targets: `zig build -Doptimize=ReleaseFast`
     - Run native test: `zig build test`
     - Upload artifacts for linux-x64 and linux-arm64
   - Job 2: build-windows (windows-latest)
     - Install Zig
     - Build win-x64 and win-arm64 targets
     - Upload artifacts
   - Job 3: build-macos (macos-latest)
     - Install Zig
     - Build osx-x64 and osx-arm64 targets
     - Upload artifacts
   - Cache Zig installation and build outputs with hash-based invalidation

Note: Actual build will happen in CI. For now, verify the files exist and have valid syntax.
  </action>
  <verify>
```bash
cd /Users/jas88/Developer/Github/SharpDicom
cat native/test/test_version.c | head -20
cat .github/workflows/native-build.yml | head -30
```
Files have valid C and YAML syntax
  </verify>
  <done>
Test executable validates native library functions work, CI workflow builds for all 6 platforms with artifact upload
  </done>
</task>

</tasks>

<verification>
- [ ] native/build.zig defines all 6 target platforms
- [ ] native/src/sharpdicom_codecs.h declares version, features, simd, error APIs
- [ ] native/src/sharpdicom_codecs.c implements all declared functions
- [ ] SIMD detection works for x86_64 (SSE2/AVX2) and aarch64 (NEON)
- [ ] Thread-local error message is properly implemented
- [ ] native/test/test_version.c compiles and tests basic functionality
- [ ] .github/workflows/native-build.yml configures 3 platform jobs
</verification>

<success_criteria>
- Zig build script can target all 6 platforms from single definition
- C API header provides complete contract for version/feature detection
- CI workflow is configured to build native libraries on push
- Foundation is ready for adding codec wrappers in subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/13-native-codecs-package/13-01-SUMMARY.md`
</output>
