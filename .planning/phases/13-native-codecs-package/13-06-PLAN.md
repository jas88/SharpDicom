---
phase: 13-native-codecs-package
plan: 06
type: execute
wave: 3
depends_on: ["13-01", "13-02", "13-03", "13-04"]
files_modified:
  - src/SharpDicom.Codecs/SharpDicom.Codecs.csproj
  - src/SharpDicom.Codecs/NativeCodecs.cs
  - src/SharpDicom.Codecs/NativeCodecException.cs
  - src/SharpDicom.Codecs/Interop/NativeMethods.cs
  - src/SharpDicom.Codecs/Interop/SafeHandles.cs
autonomous: true

must_haves:
  truths:
    - "NativeCodecs.IsAvailable reflects native library load status"
    - "P/Invoke calls successfully invoke native functions"
    - "Exceptions provide detailed error context"
  artifacts:
    - path: "src/SharpDicom.Codecs/NativeCodecs.cs"
      provides: "Static initialization and feature detection"
      exports: ["IsAvailable", "GpuAvailable", "Initialize"]
      min_lines: 150
    - path: "src/SharpDicom.Codecs/Interop/NativeMethods.cs"
      provides: "P/Invoke declarations for native functions"
      min_lines: 100
  key_links:
    - from: "src/SharpDicom.Codecs/NativeCodecs.cs"
      to: "src/SharpDicom.Codecs/Interop/NativeMethods.cs"
      via: "P/Invoke calls"
      pattern: "NativeMethods\\."
---

<objective>
Create managed P/Invoke layer for SharpDicom.Codecs package

Purpose: Establish the managed wrapper that loads native libraries, provides P/Invoke declarations, and exposes initialization and feature detection APIs to consuming code.

Output: SharpDicom.Codecs project with NativeCodecs static class and P/Invoke declarations
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-native-codecs-package/13-CONTEXT.md
@.planning/phases/13-native-codecs-package/13-RESEARCH.md
@src/SharpDicom/Codecs/IPixelDataCodec.cs
@src/SharpDicom/Codecs/CodecRegistry.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SharpDicom.Codecs project structure</name>
  <files>
    src/SharpDicom.Codecs/SharpDicom.Codecs.csproj
    src/SharpDicom.Codecs/NativeCodecException.cs
  </files>
  <action>
1. Create `src/SharpDicom.Codecs/SharpDicom.Codecs.csproj`:
   ```xml
   <Project Sdk="Microsoft.NET.Sdk">
     <PropertyGroup>
       <TargetFrameworks>netstandard2.0;net8.0;net9.0</TargetFrameworks>
       <Nullable>enable</Nullable>
       <LangVersion>latest</LangVersion>
       <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
       <AnalysisLevel>latest</AnalysisLevel>
       <GenerateDocumentationFile>true</GenerateDocumentationFile>
       <AllowUnsafeBlocks>true</AllowUnsafeBlocks>

       <!-- Package metadata -->
       <PackageId>SharpDicom.Codecs</PackageId>
       <Description>High-performance native codec wrappers for SharpDicom</Description>
       <PackageTags>DICOM;medical;imaging;codec;jpeg;jpeg2000;native</PackageTags>
       <PackageIcon>icon.png</PackageIcon>
       <PackageReadmeFile>README.md</PackageReadmeFile>

       <!-- AOT/Trim compatibility -->
       <IsAotCompatible>true</IsAotCompatible>
       <IsTrimmable>true</IsTrimmable>
       <EnableTrimAnalyzer>true</EnableTrimAnalyzer>
       <EnableAotAnalyzer>true</EnableAotAnalyzer>
     </PropertyGroup>

     <ItemGroup>
       <ProjectReference Include="..\SharpDicom\SharpDicom.csproj" />
     </ItemGroup>

     <ItemGroup Condition="'$(TargetFramework)' == 'netstandard2.0'">
       <PackageReference Include="System.Memory" />
     </ItemGroup>

     <!-- Include native libraries based on RID -->
     <ItemGroup>
       <None Include="runtimes\**\*" Pack="true" PackagePath="runtimes" />
     </ItemGroup>

     <ItemGroup>
       <None Include="..\..\README.md" Pack="true" PackagePath="" />
       <None Include="..\..\icon.png" Pack="true" PackagePath="" />
     </ItemGroup>
   </Project>
   ```

2. Create `src/SharpDicom.Codecs/NativeCodecException.cs`:
   ```csharp
   using System;
   using SharpDicom.Codecs;

   namespace SharpDicom.Codecs.Native
   {
       /// <summary>
       /// Exception thrown when native codec operations fail.
       /// </summary>
       public class NativeCodecException : DicomCodecException
       {
           /// <summary>
           /// Gets the native error code from the underlying library.
           /// </summary>
           public int NativeErrorCode { get; }

           /// <summary>
           /// Gets the error category.
           /// </summary>
           public NativeCodecErrorCategory Category { get; }

           public NativeCodecException(string message)
               : base(message) { }

           public NativeCodecException(string message, int nativeErrorCode)
               : base(message)
           {
               NativeErrorCode = nativeErrorCode;
               Category = CategorizeError(nativeErrorCode);
           }

           public NativeCodecException(string message, Exception innerException)
               : base(message, innerException) { }

           public NativeCodecException(string message, int nativeErrorCode, string nativeMessage)
               : base($"{message}: {nativeMessage}")
           {
               NativeErrorCode = nativeErrorCode;
               Category = CategorizeError(nativeErrorCode);
           }

           private static NativeCodecErrorCategory CategorizeError(int code) => code switch
           {
               -1 => NativeCodecErrorCategory.InvalidInput,
               -2 => NativeCodecErrorCategory.BufferTooSmall,
               -3 => NativeCodecErrorCategory.DecodeFailed,
               -4 => NativeCodecErrorCategory.EncodeFailed,
               -5 => NativeCodecErrorCategory.Unsupported,
               -6 => NativeCodecErrorCategory.OutOfMemory,
               -7 => NativeCodecErrorCategory.Timeout,
               -8 => NativeCodecErrorCategory.GpuUnavailable,
               _ => NativeCodecErrorCategory.Unknown
           };
       }

       public enum NativeCodecErrorCategory
       {
           Unknown,
           InvalidInput,
           BufferTooSmall,
           DecodeFailed,
           EncodeFailed,
           Unsupported,
           OutOfMemory,
           Timeout,
           GpuUnavailable
       }
   }
   ```

3. Add project to solution:
   ```bash
   dotnet sln SharpDicom.sln add src/SharpDicom.Codecs/SharpDicom.Codecs.csproj
   ```
  </action>
  <verify>
```bash
ls /Users/jas88/Developer/Github/SharpDicom/src/SharpDicom.Codecs/SharpDicom.Codecs.csproj
dotnet restore /Users/jas88/Developer/Github/SharpDicom/src/SharpDicom.Codecs/SharpDicom.Codecs.csproj
```
Project exists and restores successfully
  </verify>
  <done>
SharpDicom.Codecs project created with AOT/trim compatibility flags and exception type
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement P/Invoke layer and NativeCodecs</name>
  <files>
    src/SharpDicom.Codecs/Interop/NativeMethods.cs
    src/SharpDicom.Codecs/Interop/SafeHandles.cs
    src/SharpDicom.Codecs/NativeCodecs.cs
  </files>
  <action>
1. Create `src/SharpDicom.Codecs/Interop/NativeMethods.cs`:
   ```csharp
   using System;
   using System.Runtime.InteropServices;
   #if NET7_0_OR_GREATER
   using System.Runtime.CompilerServices;
   #endif

   namespace SharpDicom.Codecs.Native.Interop
   {
       internal static unsafe partial class NativeMethods
       {
           private const string LibName = "sharpdicom_codecs";

   #if NET7_0_OR_GREATER
           [LibraryImport(LibName)]
           internal static partial int sharpdicom_version();

           [LibraryImport(LibName)]
           internal static partial int sharpdicom_features();

           [LibraryImport(LibName)]
           internal static partial int sharpdicom_simd_features();

           [LibraryImport(LibName)]
           internal static partial IntPtr sharpdicom_last_error();

           // JPEG
           [LibraryImport(LibName)]
           internal static partial int jpeg_decode(
               byte* input, int inputLen,
               byte* output, int outputLen,
               out int width, out int height, out int components,
               int colorspace);

           [LibraryImport(LibName)]
           internal static partial int jpeg_encode(
               byte* input, int width, int height, int components,
               out byte* output, out int outputLen,
               int quality, int subsamp);

           [LibraryImport(LibName)]
           internal static partial void jpeg_free(byte* buffer);

           // JPEG 2000
           [LibraryImport(LibName)]
           internal static partial int j2k_decode(
               byte* input, int inputLen,
               byte* output, int outputLen,
               out int width, out int height, out int components, out int bitsPerSample,
               int resolutionLevel);

           [LibraryImport(LibName)]
           internal static partial int j2k_encode(
               byte* input, int width, int height, int components, int bitsPerSample,
               out byte* output, out int outputLen,
               int lossless, float compressionRatio, int tileSize);

           [LibraryImport(LibName)]
           internal static partial void j2k_free(byte* buffer);

           // JPEG-LS
           [LibraryImport(LibName)]
           internal static partial int jls_decode(
               byte* input, int inputLen,
               byte* output, int outputLen,
               out int width, out int height, out int components, out int bitsPerSample);

           [LibraryImport(LibName)]
           internal static partial int jls_encode(
               byte* input, int width, int height, int components, int bitsPerSample,
               out byte* output, out int outputLen,
               int nearLossless);

           [LibraryImport(LibName)]
           internal static partial void jls_free(byte* buffer);

           // GPU
           [LibraryImport(LibName)]
           internal static partial int gpu_available();

           [LibraryImport(LibName)]
           internal static partial int gpu_j2k_decode(
               byte* input, int inputLen,
               byte* output, int outputLen,
               out int width, out int height, out int components, out int bitsPerSample);
   #else
           [DllImport(LibName, CallingConvention = CallingConvention.Cdecl)]
           internal static extern int sharpdicom_version();

           [DllImport(LibName, CallingConvention = CallingConvention.Cdecl)]
           internal static extern int sharpdicom_features();

           [DllImport(LibName, CallingConvention = CallingConvention.Cdecl)]
           internal static extern int sharpdicom_simd_features();

           [DllImport(LibName, CallingConvention = CallingConvention.Cdecl)]
           internal static extern IntPtr sharpdicom_last_error();

           [DllImport(LibName, CallingConvention = CallingConvention.Cdecl)]
           internal static extern int jpeg_decode(
               byte* input, int inputLen,
               byte* output, int outputLen,
               out int width, out int height, out int components,
               int colorspace);

           // ... (repeat for other functions with DllImport)
           [DllImport(LibName, CallingConvention = CallingConvention.Cdecl)]
           internal static extern void jpeg_free(byte* buffer);

           [DllImport(LibName, CallingConvention = CallingConvention.Cdecl)]
           internal static extern int gpu_available();
   #endif
       }
   }
   ```

2. Create `src/SharpDicom.Codecs/Interop/SafeHandles.cs`:
   ```csharp
   using System;
   using System.Runtime.InteropServices;

   namespace SharpDicom.Codecs.Native.Interop
   {
       /// <summary>
       /// Safe handle for video decoder state.
       /// </summary>
       internal sealed class VideoDecoderHandle : SafeHandle
       {
           public VideoDecoderHandle() : base(IntPtr.Zero, true) { }

           public override bool IsInvalid => handle == IntPtr.Zero;

           protected override bool ReleaseHandle()
           {
               NativeMethods.video_decoder_destroy(handle);
               return true;
           }
       }
   }
   ```

3. Create `src/SharpDicom.Codecs/NativeCodecs.cs`:
   ```csharp
   using System;
   using System.Reflection;
   using System.Runtime.InteropServices;
   using System.Threading;
   using SharpDicom.Codecs.Native.Interop;
   #if NET5_0_OR_GREATER
   using System.Runtime.CompilerServices;
   #endif

   namespace SharpDicom.Codecs.Native
   {
       /// <summary>
       /// Entry point for native codec initialization and feature detection.
       /// </summary>
       public static class NativeCodecs
       {
           private const int ExpectedVersion = 1;
           private static int _initialized;
           private static Exception? _initException;

           /// <summary>
           /// Gets whether native codecs are available.
           /// </summary>
           public static bool IsAvailable { get; private set; }

           /// <summary>
           /// Gets whether GPU acceleration is available.
           /// </summary>
           public static bool GpuAvailable { get; private set; }

           /// <summary>
           /// Gets the active SIMD features.
           /// </summary>
           public static SimdFeatures ActiveSimdFeatures { get; private set; }

           /// <summary>
           /// Gets or sets whether to prefer CPU over GPU.
           /// </summary>
           public static bool PreferCpu { get; set; }

           /// <summary>
           /// Gets or sets whether JPEG codec is enabled.
           /// </summary>
           public static bool EnableJpeg { get; set; } = true;

           /// <summary>
           /// Gets or sets whether JPEG 2000 codec is enabled.
           /// </summary>
           public static bool EnableJpeg2000 { get; set; } = true;

           /// <summary>
           /// Gets or sets whether JPEG-LS codec is enabled.
           /// </summary>
           public static bool EnableJpegLs { get; set; } = true;

   #if NET5_0_OR_GREATER
           [ModuleInitializer]
           internal static void AutoInitialize()
           {
               if (!AppContext.TryGetSwitch("SharpDicom.Codecs.DisableAutoInit", out var disabled) || !disabled)
               {
                   try
                   {
                       Initialize();
                   }
                   catch
                   {
                       // Suppress initialization errors in auto-init
                       // User can call Initialize() explicitly for error details
                   }
               }
           }
   #endif

           /// <summary>
           /// Initializes native codecs. Throws if initialization fails.
           /// </summary>
           public static void Initialize(NativeCodecOptions? options = null)
           {
               if (Interlocked.Exchange(ref _initialized, 1) == 1)
               {
                   if (_initException != null)
                       throw _initException;
                   return;
               }

               try
               {
                   // Set custom resolver if needed
                   SetupDllResolver();

                   // Verify version
                   int version = NativeMethods.sharpdicom_version();
                   if (version != ExpectedVersion && !(options?.SkipVersionCheck ?? false))
                   {
                       throw new NativeCodecException(
                           $"Native library version mismatch: expected {ExpectedVersion}, got {version}");
                   }

                   // Detect features
                   int features = NativeMethods.sharpdicom_features();
                   ActiveSimdFeatures = (SimdFeatures)NativeMethods.sharpdicom_simd_features();
                   GpuAvailable = NativeMethods.gpu_available() != 0;

                   IsAvailable = true;

                   // Register codecs
                   RegisterCodecs(features);
               }
               catch (DllNotFoundException ex)
               {
                   _initException = new NativeCodecException(
                       $"Native library not found. Ensure SharpDicom.Codecs.runtime.{RuntimeInformation.RuntimeIdentifier} is installed.",
                       ex);
                   throw _initException;
               }
               catch (Exception ex) when (ex is not NativeCodecException)
               {
                   _initException = new NativeCodecException("Failed to initialize native codecs", ex);
                   throw _initException;
               }
           }

           private static void SetupDllResolver()
           {
   #if NET5_0_OR_GREATER
               NativeLibrary.SetDllImportResolver(typeof(NativeCodecs).Assembly, DllImportResolver);
   #endif
           }

   #if NET5_0_OR_GREATER
           private static IntPtr DllImportResolver(string libraryName, Assembly assembly, DllImportSearchPath? searchPath)
           {
               if (libraryName == "sharpdicom_codecs")
               {
                   // Try loading from custom path if set
                   // Otherwise let default resolution happen
               }
               return IntPtr.Zero;
           }
   #endif

           private static void RegisterCodecs(int features)
           {
               // Registration with priority 100 (above pure C# at 50)
               // Actual codec classes created in Plan 07
           }

           internal static string GetLastError()
           {
               IntPtr ptr = NativeMethods.sharpdicom_last_error();
               return ptr == IntPtr.Zero ? string.Empty : Marshal.PtrToStringAnsi(ptr) ?? string.Empty;
           }
       }

       /// <summary>
       /// Options for native codec initialization.
       /// </summary>
       public sealed class NativeCodecOptions
       {
           public bool SkipVersionCheck { get; set; }
           public bool ForceScalar { get; set; }
           public bool PreferCpu { get; set; }
       }

       [Flags]
       public enum SimdFeatures
       {
           None = 0,
           Sse2 = 1,
           Avx2 = 2,
           Neon = 4
       }
   }
   ```
  </action>
  <verify>
```bash
dotnet build /Users/jas88/Developer/Github/SharpDicom/src/SharpDicom.Codecs/SharpDicom.Codecs.csproj
```
Project builds without errors
  </verify>
  <done>
P/Invoke layer provides complete native function declarations, NativeCodecs handles initialization and feature detection
  </done>
</task>

</tasks>

<verification>
- [ ] SharpDicom.Codecs.csproj targets netstandard2.0, net8.0, net9.0
- [ ] Project references SharpDicom core
- [ ] IsAotCompatible and IsTrimmable are set
- [ ] NativeCodecException provides error categorization
- [ ] NativeMethods.cs has both LibraryImport (NET7+) and DllImport versions
- [ ] All native functions have P/Invoke declarations
- [ ] NativeCodecs.Initialize() loads library and detects features
- [ ] ModuleInitializer auto-initializes on supported frameworks
- [ ] DllImportResolver setup for custom library paths
- [ ] Project builds on all target frameworks
</verification>

<success_criteria>
- SharpDicom.Codecs project compiles successfully
- P/Invoke layer provides type-safe access to all native functions
- NativeCodecs.Initialize() correctly loads native library
- Feature detection (SIMD, GPU) works via P/Invoke
- Exception type provides detailed error context
- AOT/trim analyzers pass without warnings
</success_criteria>

<output>
After completion, create `.planning/phases/13-native-codecs-package/13-06-SUMMARY.md`
</output>
