---
phase: 13-native-codecs-package
plan: 04
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - native/vendor/charls/.gitkeep
  - native/src/jls_wrapper.h
  - native/src/jls_wrapper.c
  - native/vendor/ffmpeg/.gitkeep
  - native/src/video_wrapper.h
  - native/src/video_wrapper.c
  - native/src/sharpdicom_codecs.c
  - native/build.zig
autonomous: true

must_haves:
  truths:
    - "JPEG-LS decode produces correct lossless pixel data"
    - "JPEG-LS encode produces valid near-lossless output"
    - "Video decode extracts frames from MPEG2/4/HEVC streams"
  artifacts:
    - path: "native/src/jls_wrapper.c"
      provides: "CharLS wrapper implementation"
      exports: ["jls_decode", "jls_encode", "jls_free"]
      min_lines: 100
    - path: "native/src/video_wrapper.c"
      provides: "FFmpeg wrapper implementation"
      exports: ["video_decoder_create", "video_decode_frame", "video_decoder_destroy"]
      min_lines: 150
  key_links:
    - from: "native/src/sharpdicom_codecs.c"
      to: "native/src/jls_wrapper.c"
      via: "include and feature flag"
      pattern: "SHARPDICOM_HAS_JLS"
    - from: "native/src/sharpdicom_codecs.c"
      to: "native/src/video_wrapper.c"
      via: "include and feature flag"
      pattern: "SHARPDICOM_HAS_MPEG"
---

<objective>
Implement CharLS wrapper for JPEG-LS and FFmpeg wrapper for video codecs

Purpose: Provide JPEG-LS lossless/near-lossless encoding via CharLS (2x faster than HP reference), and video frame extraction via FFmpeg for MPEG2/MPEG4/HEVC encoded DICOM.

Output: JPEG-LS and video decoder wrapper functions
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-native-codecs-package/13-CONTEXT.md
@.planning/phases/13-native-codecs-package/13-RESEARCH.md
@.planning/phases/13-native-codecs-package/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement JPEG-LS wrapper (CharLS)</name>
  <files>
    native/vendor/charls/.gitkeep
    native/src/jls_wrapper.h
    native/src/jls_wrapper.c
  </files>
  <action>
1. Create `native/vendor/charls/.gitkeep` placeholder

2. Update `native/vendor/README.md` to add CharLS:
   - CharLS: version 2.4.x, source from https://github.com/team-charls/charls
   - License: BSD-3-Clause
   - Note: ~2x faster than HP reference implementation

3. Update CI workflow to download CharLS:
   ```yaml
   - name: Download CharLS
     run: |
       curl -L https://github.com/team-charls/charls/archive/refs/tags/2.4.2.tar.gz | tar xz
       mv charls-2.4.2 native/vendor/charls
   ```

4. Create `native/src/jls_wrapper.h`:
   - Include guard and extern "C"
   - Function declarations:
     ```c
     int jls_decode(
         const uint8_t* input, int inputLen,
         uint8_t* output, int outputLen,
         int* width, int* height, int* components, int* bitsPerSample);

     int jls_encode(
         const uint8_t* input, int width, int height, int components, int bitsPerSample,
         uint8_t** output, int* outputLen,
         int nearLossless);  // 0=lossless, >0=near-lossless threshold

     void jls_free(uint8_t* buffer);
     ```

5. Create `native/src/jls_wrapper.c`:
   - Include charls/charls.h
   - jls_decode():
     - charls_jpegls_decoder_create()
     - charls_jpegls_decoder_set_source_buffer()
     - charls_jpegls_decoder_read_header()
     - Get frame info (width, height, bits_per_sample, component_count)
     - Validate output buffer size
     - charls_jpegls_decoder_decode_to_buffer()
     - charls_jpegls_decoder_destroy()
     - On error: charls_get_error_message() -> set_error()
   - jls_encode():
     - charls_jpegls_encoder_create()
     - Set frame_info: width, height, bits_per_sample, component_count
     - charls_jpegls_encoder_set_frame_info()
     - If nearLossless > 0: charls_jpegls_encoder_set_near_lossless()
     - Estimate buffer size, allocate output
     - charls_jpegls_encoder_encode_from_buffer()
     - charls_jpegls_encoder_destroy()
   - jls_free(): free() the allocated buffer
  </action>
  <verify>
```bash
ls /Users/jas88/Developer/Github/SharpDicom/native/src/jls_wrapper.c
grep "jls_decode" /Users/jas88/Developer/Github/SharpDicom/native/src/jls_wrapper.c
```
JPEG-LS wrapper file exists with decode/encode functions
  </verify>
  <done>
JPEG-LS wrapper provides lossless and near-lossless encode/decode using CharLS
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement video wrapper (FFmpeg)</name>
  <files>
    native/vendor/ffmpeg/.gitkeep
    native/src/video_wrapper.h
    native/src/video_wrapper.c
    native/src/sharpdicom_codecs.c
    native/build.zig
  </files>
  <action>
1. Create `native/vendor/ffmpeg/.gitkeep` placeholder

2. Update `native/vendor/README.md` to add FFmpeg:
   - FFmpeg: version 6.x or 7.x, minimal subset (libavcodec, libavutil)
   - License: LGPL-2.1+ or GPL-2.0+ (depending on codecs enabled)
   - Note: Only decode support needed; encode is optional
   - Build with: --enable-gpl --enable-libx264 --enable-libx265

3. Update CI workflow - FFmpeg is complex, use prebuilt:
   ```yaml
   - name: Install FFmpeg dev
     run: |
       # Linux: apt install libavcodec-dev
       # Windows: download from gyan.dev or BtbN builds
       # macOS: brew install ffmpeg
   ```

4. Create `native/src/video_wrapper.h`:
   - Include guard and extern "C"
   - Codec ID enum matching FFmpeg:
     ```c
     #define VIDEO_CODEC_MPEG2  2
     #define VIDEO_CODEC_MPEG4  12
     #define VIDEO_CODEC_H264   27
     #define VIDEO_CODEC_HEVC   173
     ```
   - Function declarations:
     ```c
     // Opaque decoder handle
     typedef struct video_decoder video_decoder;

     video_decoder* video_decoder_create(int codecId);

     int video_decode_frame(
         video_decoder* decoder,
         const uint8_t* input, int inputLen,
         uint8_t* output, int outputLen,
         int* width, int* height, int* pixelFormat);

     // Seek to specific frame
     int video_seek_frame(video_decoder* decoder, int frameNumber);

     // Get frame count if known
     int video_get_frame_count(video_decoder* decoder);

     void video_decoder_destroy(video_decoder* decoder);
     ```

5. Create `native/src/video_wrapper.c`:
   - Include libavcodec/avcodec.h, libavutil/frame.h
   - video_decoder struct:
     ```c
     struct video_decoder {
         AVCodecContext* ctx;
         AVFrame* frame;
         AVPacket* pkt;
         int codec_id;
     };
     ```
   - video_decoder_create():
     - avcodec_find_decoder(codecId)
     - avcodec_alloc_context3()
     - avcodec_open2()
     - av_frame_alloc(), av_packet_alloc()
   - video_decode_frame():
     - av_packet_from_data() or manual setup
     - avcodec_send_packet()
     - avcodec_receive_frame()
     - Convert frame to output format (sws_scale if needed)
     - Handle YUV420P -> RGB conversion
   - video_decoder_destroy():
     - av_frame_free(), av_packet_free(), avcodec_free_context()

6. Update `native/src/sharpdicom_codecs.c`:
   - Include jls_wrapper.h and video_wrapper.h
   - Update sharpdicom_features() to set SHARPDICOM_HAS_JLS and SHARPDICOM_HAS_MPEG bits

7. Update `native/build.zig`:
   - Add jls_wrapper.c and video_wrapper.c to source files
   - Link against CharLS and FFmpeg libraries
   - Add include paths
  </action>
  <verify>
```bash
ls /Users/jas88/Developer/Github/SharpDicom/native/src/video_wrapper.c
grep "SHARPDICOM_HAS_JLS" /Users/jas88/Developer/Github/SharpDicom/native/src/sharpdicom_codecs.c
grep "SHARPDICOM_HAS_MPEG" /Users/jas88/Developer/Github/SharpDicom/native/src/sharpdicom_codecs.c
```
Video wrapper exists, both JLS and MPEG feature flags set
  </verify>
  <done>
Video wrapper provides frame extraction for MPEG2/4 and HEVC, both wrappers integrated into main sharpdicom_codecs
  </done>
</task>

</tasks>

<verification>
- [ ] native/vendor/charls/.gitkeep exists
- [ ] native/vendor/ffmpeg/.gitkeep exists
- [ ] native/vendor/README.md documents CharLS and FFmpeg
- [ ] native/src/jls_wrapper.h declares JPEG-LS functions
- [ ] native/src/jls_wrapper.c implements CharLS API usage
- [ ] native/src/video_wrapper.h declares video decoder functions
- [ ] native/src/video_wrapper.c implements FFmpeg API usage
- [ ] Handle-based API for video decoder supports multi-frame
- [ ] sharpdicom_features() reports JLS and MPEG capabilities
- [ ] build.zig includes both wrappers and links libraries
</verification>

<success_criteria>
- JPEG-LS wrapper provides lossless and near-lossless encode/decode
- Video wrapper extracts frames from MPEG2/MPEG4/HEVC streams
- Handle-based video API enables stateful multi-frame decode
- Feature flags correctly report available codecs
- All wrappers follow established error handling pattern
</success_criteria>

<output>
After completion, create `.planning/phases/13-native-codecs-package/13-04-SUMMARY.md`
</output>
