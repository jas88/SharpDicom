---
phase: 07-file-writing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/SharpDicom/IO/DicomStreamWriter.cs
  - src/SharpDicom/IO/DicomWriterOptions.cs
  - src/SharpDicom/Data/TransferSyntax.cs
  - tests/SharpDicom.Tests/IO/DicomStreamWriterTests.cs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "DicomStreamWriter can write elements with explicit VR little endian encoding"
    - "DicomStreamWriter can write elements with implicit VR little endian encoding"
    - "DicomStreamWriter produces correct byte layout for 16-bit and 32-bit length VRs"
    - "Value padding is applied correctly (space for strings, null for binary)"
    - "Endianness is respected for big endian transfer syntax"
  artifacts:
    - path: "src/SharpDicom/IO/DicomStreamWriter.cs"
      provides: "Low-level IBufferWriter-based element writing"
      exports: ["DicomStreamWriter"]
    - path: "src/SharpDicom/IO/DicomWriterOptions.cs"
      provides: "Writer configuration (transfer syntax, length encoding, buffer size)"
      exports: ["DicomWriterOptions", "SequenceLengthEncoding"]
    - path: "tests/SharpDicom.Tests/IO/DicomStreamWriterTests.cs"
      provides: "Element writing verification tests"
      min_lines: 200
  key_links:
    - from: "src/SharpDicom/IO/DicomStreamWriter.cs"
      to: "System.Buffers.IBufferWriter<byte>"
      via: "WriteElement uses GetSpan/Advance pattern"
      pattern: "GetSpan.*Advance"
    - from: "src/SharpDicom/IO/DicomStreamWriter.cs"
      to: "src/SharpDicom/Data/DicomVRInfo.cs"
      via: "VR metadata lookup for length encoding"
      pattern: "DicomVRInfo\\.GetInfo"
---

<objective>
Implement DicomStreamWriter for low-level DICOM element writing using IBufferWriter<byte>.

Purpose: Provides the foundation for file writing by enabling efficient, zero-copy element serialization to any buffer target (Stream, PipeWriter, ArrayBufferWriter).

Output: DicomStreamWriter class with element writing methods, DicomWriterOptions configuration class.
</objective>

<execution_context>
@/Users/jas88/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jas88/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-file-writing/07-CONTEXT.md
@.planning/phases/07-file-writing/07-RESEARCH.md
@src/SharpDicom/IO/DicomStreamReader.cs
@src/SharpDicom/Data/DicomVR.cs
@src/SharpDicom/Data/DicomVRInfo.cs
@src/SharpDicom/Data/IDicomElement.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DicomWriterOptions and SequenceLengthEncoding</name>
  <files>src/SharpDicom/IO/DicomWriterOptions.cs, src/SharpDicom/Data/TransferSyntax.cs</files>
  <action>
Create DicomWriterOptions class with configuration for file writing:

```csharp
public class DicomWriterOptions
{
    // Transfer syntax for dataset (FMI always Explicit VR LE)
    public TransferSyntax TransferSyntax { get; init; } = TransferSyntax.ExplicitVRLittleEndian;

    // Sequence length encoding (Undefined = delimiters, Defined = calculated lengths)
    public SequenceLengthEncoding SequenceLength { get; init; } = SequenceLengthEncoding.Undefined;

    // Buffering
    public int BufferSize { get; init; } = 81920;  // 80KB default

    // Default preset
    public static readonly DicomWriterOptions Default = new();
}

public enum SequenceLengthEncoding
{
    Undefined,  // Use delimiters (FFFE,E00D/E0DD)
    Defined     // Calculate and write explicit lengths
}
```

Add DeflatedExplicitVRLittleEndian to TransferSyntax.cs:

```csharp
public static readonly TransferSyntax DeflatedExplicitVRLittleEndian = new()
{
    UID = new DicomUID("1.2.840.10008.1.2.1.99"),
    IsExplicitVR = true,
    IsLittleEndian = true,
    IsEncapsulated = false,
    IsLossy = false,
    Compression = CompressionType.None,  // Deflate is at stream level, not pixel level
    IsKnown = true
};
```

Update TransferSyntax.FromUID to recognize the deflated TS.
  </action>
  <verify>Build succeeds with `dotnet build src/SharpDicom --nologo -v q`</verify>
  <done>DicomWriterOptions class exists with TransferSyntax, SequenceLength, BufferSize properties. DeflatedExplicitVRLittleEndian transfer syntax is defined.</done>
</task>

<task type="auto">
  <name>Task 2: Implement DicomStreamWriter core element writing</name>
  <files>src/SharpDicom/IO/DicomStreamWriter.cs</files>
  <action>
Create DicomStreamWriter class that writes DICOM elements to IBufferWriter<byte>:

```csharp
public sealed class DicomStreamWriter
{
    private readonly IBufferWriter<byte> _writer;
    private readonly DicomWriterOptions _options;
    private readonly bool _explicitVR;
    private readonly bool _littleEndian;

    public DicomStreamWriter(IBufferWriter<byte> writer, DicomWriterOptions? options = null);

    // Write a single element (not sequences - those in Plan 03)
    public void WriteElement(IDicomElement element);

    // Write tag only (for delimiters)
    public void WriteTag(DicomTag tag);

    // Write raw bytes
    public void WriteBytes(ReadOnlySpan<byte> bytes);
}
```

Element writing follows DICOM Part 5 encoding rules:

**Explicit VR Little Endian (16-bit length VRs: AE, AS, AT, CS, DA, DS, DT, FL, FD, IS, LO, LT, PN, SH, SL, SS, ST, TM, UI, UL, US):**
- Tag (4 bytes): group LE + element LE
- VR (2 bytes): ASCII
- Length (2 bytes): LE
- Value (n bytes)

**Explicit VR (32-bit length VRs: OB, OD, OF, OL, OV, OW, SQ, SV, UC, UN, UR, UT, UV):**
- Tag (4 bytes): group LE + element LE
- VR (2 bytes): ASCII
- Reserved (2 bytes): 0x0000
- Length (4 bytes): LE (or 0xFFFFFFFF for undefined)
- Value (n bytes)

**Implicit VR Little Endian:**
- Tag (4 bytes): group LE + element LE
- Length (4 bytes): LE
- Value (n bytes)

Use BinaryPrimitives for endian-safe writing. Use DicomVRInfo.GetInfo(vr).Is16BitLength to determine length field size.

**Value padding:** Ensure even length by checking `(length & 1) == 1`. Use DicomVRInfo.PaddingByte (0x20 for string VRs, 0x00 for binary VRs).

**Big endian support:** Check _littleEndian flag and use WriteUInt16BigEndian/WriteUInt32BigEndian accordingly.
  </action>
  <verify>Build succeeds with `dotnet build src/SharpDicom --nologo -v q`</verify>
  <done>DicomStreamWriter can write elements with correct header format for both explicit and implicit VR, with proper endianness and value padding.</done>
</task>

<task type="auto">
  <name>Task 3: Create DicomStreamWriter tests</name>
  <files>tests/SharpDicom.Tests/IO/DicomStreamWriterTests.cs</files>
  <action>
Create comprehensive tests for DicomStreamWriter:

1. **Explicit VR Little Endian - 16-bit length VRs:**
   - Test AE, CS, DA, DS, IS, LO, PN, SH, UI, US, UL elements
   - Verify tag, VR, length, value bytes in output
   - Verify 8-byte header for 16-bit length VRs

2. **Explicit VR Little Endian - 32-bit length VRs:**
   - Test OB, OW, UN, UC, UT elements
   - Verify 12-byte header (tag + VR + reserved + length)
   - Verify reserved bytes are 0x0000

3. **Implicit VR Little Endian:**
   - Test same elements without VR field
   - Verify 8-byte header (tag + length only)

4. **Big Endian:**
   - Test ExplicitVRBigEndian transfer syntax
   - Verify tag and length bytes are big endian

5. **Value Padding:**
   - Test odd-length string value gets space padding
   - Test odd-length binary value gets null padding
   - Test even-length values are not padded

6. **Edge Cases:**
   - Empty value (length 0)
   - Maximum length (if applicable)
   - UI VR with null padding (not space)

Use ArrayBufferWriter<byte> as the IBufferWriter target for testing. Verify output bytes match expected DICOM encoding using ReadOnlySpan<byte> comparisons.
  </action>
  <verify>All tests pass with `dotnet test tests/SharpDicom.Tests --filter "FullyQualifiedName~DicomStreamWriterTests" --nologo -v q`</verify>
  <done>DicomStreamWriter tests verify correct byte output for all VR types, both transfer syntaxes, and proper padding behavior.</done>
</task>

</tasks>

<verification>
1. `dotnet build --nologo -v q` succeeds with no errors
2. `dotnet test tests/SharpDicom.Tests --nologo -v q` passes all tests
3. New DicomStreamWriter tests specifically verify byte-level encoding
</verification>

<success_criteria>
- DicomWriterOptions class exists with TransferSyntax, SequenceLength, BufferSize
- SequenceLengthEncoding enum defines Undefined and Defined modes
- DeflatedExplicitVRLittleEndian transfer syntax is available
- DicomStreamWriter writes elements to IBufferWriter<byte>
- Explicit VR encoding uses correct 8-byte or 12-byte headers
- Implicit VR encoding uses 8-byte headers without VR field
- Big endian byte order is respected
- Value padding applies correct byte (0x20 or 0x00) based on VR
- All new tests pass
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-file-writing/07-01-SUMMARY.md`
</output>
